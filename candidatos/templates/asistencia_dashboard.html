{% extends 'base.html' %} 
{% load static %}

{% block title %}Registro de Asistencia Rápida{% endblock %} 

{% block content %}
    
    <div class="flex flex-col items-center p-4 min-h-screen bg-gray-50">

        <div class="w-full max-w-sm bg-white p-8 rounded-3xl shadow-2xl mt-8 border-t-4 border-red-600/70 transform transition-all duration-300 hover:shadow-red-500/20">
            
            <header class="mb-6 text-center">
                <div class="inline-flex items-center justify-center p-3 bg-red-100 rounded-full mb-3 shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h1 class="text-xl font-extrabold text-gray-900 leading-snug tracking-tighter">
                    Control de Asistencia Rápida
                </h1>
                <p class="text-xs text-gray-500 font-medium mt-1">
                    HOY: <span class="text-red-600 font-bold tracking-wider">{{ today|date:"d M Y"|upper }}</span>
                </p>
            </header>

            <form id="dni-search-form" method="POST" action="{% url 'asistencia_dashboard' %}" class="space-y-6">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="dni" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                        Escanea o Digita DNI
                    </label>
                    
                    <div id="interactive-reader" class="viewport mb-4 hidden bg-gray-900 rounded-lg overflow-hidden border-2 border-red-600/50 h-64 sm:h-80">
                    </div>
                    
                    <div class="relative">
                        <input type="text" id="dni" name="dni" placeholder="DNI..."
                                class="w-full p-4 border-b-4 border-red-500/50 rounded-lg text-2xl text-center font-extrabold tracking-widest bg-red-50 text-red-800
                                       focus:outline-none focus:ring-4 focus:ring-red-200 focus:border-red-700 transition duration-200"
                                required autofocus autocomplete="off" minlength="8" maxlength="8">
                        
                        <button type="button" id="scan-button" 
                                class="absolute right-0 top-0 h-full px-3 text-red-600 hover:text-red-800 transition duration-150"
                                title="Activar Escaneo de Código de Barras">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10M10 4h4M10 20h4M7 4h.01M17 4h.01M7 20h.01M17 20h.01M16 7a4 4 0 00-4-4H8a4 4 0 00-4 4v10a4 4 0 004 4h4a4 4 0 004-4V7z" />
                            </svg>
                        </button>
                    </div>

                </div>
                
                <button type="submit" id="search-button"
                        class="w-full py-2.5 bg-red-600 text-white font-extrabold rounded-full hover:bg-red-700 transition duration-200 
                               shadow-xl shadow-red-500/30 uppercase tracking-wider transform hover:scale-[1.01] active:scale-95">
                    <span id="search-text" class="text-xs">Buscar Candidato (ENTER)</span>
                </button>
            </form>
        </div>
        
        <div id="asistencia-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[1000] flex items-center justify-center backdrop-blur-sm hidden">
            <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-xs transform transition-all duration-300 scale-95 opacity-0 border-t-4 border-gray-300">
                
                <h2 class="text-base font-extrabold mb-4 text-gray-900 tracking-tight">
                    Confirmar Registro
                </h2>
                
                <div class="mb-4 pb-3 border-b border-dashed border-gray-200">
                    <p class="text-lg font-bold text-gray-800" id="modal-candidato-nombre"></p>
                    <p class="text-sm text-gray-500 mt-1">DNI: <span id="modal-candidato-dni" class="font-bold text-gray-700"></span></p>
                </div>

                <div class="bg-red-50 p-3 rounded-xl border border-red-200 mb-5 text-center">
                    <p class="text-[10px] font-extrabold text-red-700 uppercase tracking-wider mb-1">
                        Hora de Registro
                    </p>
                    <p class="text-xl font-extrabold text-red-900 tracking-tight" id="modal-current-time">
                    </p>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-5">
                    <p class="text-[10px] font-extrabold text-gray-500 uppercase tracking-wider mb-1">
                        Fase Actual en Proceso:
                    </p>
                    <p class="text-base font-extrabold text-red-700" id="modal-fase-proceso"></p>
                    <hr class="my-2 border-gray-100">
                    <p class="text-[10px] text-gray-500" id="modal-ultimo-registro">Último Registro Hoy: N/A</p>
                </div>

                <form id="registro-asistencia-form" method="POST" action="{% url 'registrar_asistencia_rapida' %}">
                    {% csrf_token %}
                    <input type="hidden" name="proceso_id" id="modal-proceso-id">
                    <input type="hidden" name="fase_actual" id="modal-fase-actual">
                    <input type="hidden" name="movimiento" id="modal-movimiento">
                    <input type="hidden" name="estado_asistencia" value="A">

                    <div id="movimiento-display">
                    </div>

                    <div class="flex justify-between space-x-3 mt-4">
                        <button type="button" onclick="closeModal()"
                                class="flex-1 py-2 text-xs font-medium border border-gray-300 rounded-full text-gray-700 
                                        hover:bg-gray-100 hover:shadow-md transition duration-150 transform hover:scale-[1.01]">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    {{ block.super }} 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'js/html5-qrcode.min.js' %}"></script>
    <script>
        const modal = document.getElementById('asistencia-modal');
        const dniInput = document.getElementById('dni');
        const interactiveReader = document.getElementById('interactive-reader');
        const scanButton = document.getElementById('scan-button');
        let scannerActivo = false;

        const html5Qrcode = new Html5Qrcode("interactive-reader");

        function openModal() {
            const currentTime = new Date().toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('modal-current-time').textContent = currentTime;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.bg-white').classList.add('scale-100', 'opacity-100');
            }, 50);
        }

        window.closeModal = function() {
            modal.querySelector('.bg-white').classList.remove('scale-100', 'opacity-100');
            modal.querySelector('.bg-white').classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                dniInput.value = ''; 
                dniInput.focus();
            }, 300);
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Código detectado (completo): ${decodedText}`);

            let dniExtraido = '';
            
            const code = decodedText;
            const dataFields = code.split('|');
            
            if (dataFields.length >= 4) {
                dniExtraido = dataFields[3].trim(); 
            } 
            
            if (dniExtraido.length !== 8) {
                const match = code.match(/\d{8}/);
                if (match) {
                    dniExtraido = match[0];
                }
            }
            
            if (dniExtraido.length === 8 && /^\d+$/.test(dniExtraido)) {
                dniInput.value = dniExtraido;
                stopScanner(); a
                $('#dni-search-form').submit(); 
            } else {
                console.warn(`No se pudo extraer DNI válido (8 dígitos) de la cadena: ${code}`);
            }
        }

        function onScanError(errorMessage) {
           
        }

        function startScanner() {
            interactiveReader.classList.remove('hidden');
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }, 
                aspectRatio: 1.7777777778,  
                videoConstraints: {
                    facingMode: { exact: "environment" }
                }
            };

            html5Qrcode.start(
                config.videoConstraints, 
                config, 
                onScanSuccess, 
                onScanError
            )
            .then(() => {
                scannerActivo = true;
                scanButton.classList.add('text-green-600', 'hover:text-green-800'); 
                scanButton.classList.remove('text-red-600', 'hover:text-red-800');
                scanButton.title = "Detener Escaneo";
            })
            .catch((err) => {
                console.error("Error al iniciar html5-qrcode:", err);
                alert("⚠️ Error: No se pudo acceder a la cámara. Asegúrese de tener permisos. (Error: " + err.name + ")");
                interactiveReader.classList.add('hidden');
            });
        }

        function stopScanner() {
            if (scannerActivo) {
                html5Qrcode.stop()
                .then(() => {
                    interactiveReader.classList.add('hidden');
                    scannerActivo = false;
                    scanButton.classList.remove('text-green-600', 'hover:text-green-800');
                    scanButton.classList.add('text-red-600', 'hover:text-red-800');
                    scanButton.title = "Activar Escaneo de Código de Barras";
                })
                .catch((err) => {
                    console.error("Error al detener html5-qrcode:", err);
                });
            }
        }

        scanButton.addEventListener('click', function() {
            if (scannerActivo) {
                stopScanner();
            } else {
                startScanner();
            }
        });
        
        $(document).ready(function() {
            
            const movimientoDisplay = document.getElementById('movimiento-display');
            const searchButtonText = document.getElementById('search-text');
            const searchButton = $('#search-button');
            
            $('#dni-search-form').on('submit', function(e) {
                e.preventDefault(); 
                
                const dni = dniInput.value.trim();
                const form = $(this);

                if (dni.length !== 8) { 
                    alert("Por favor, ingrese un DNI válido de 8 dígitos.");
                    return;
                }
                
                searchButton.prop('disabled', true);
                searchButtonText.textContent = 'Buscando...'; 

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' 
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            $('#modal-candidato-nombre').text(response.candidato_nombre);
                            $('#modal-candidato-dni').text(response.candidato_dni);
                            $('#modal-fase-proceso').text(response.fase_proceso);
                            $('#modal-proceso-id').val(response.proceso_id);
                            $('#modal-fase-actual').val(response.fase_proceso_key);
                            
                            const ultimoRegistroText = response.ultimo_registro ? `Último Registro Hoy: ${response.ultimo_registro}` : 'Aún no hay registros hoy.';
                            $('#modal-ultimo-registro').text(ultimoRegistroText);
                            
                            const movimiento = response.movimiento_requerido;
                            $('#modal-movimiento').val(movimiento);
                            
                            let buttonHtml = '';
                            let buttonText, buttonColor, buttonIcon;
                            
                            if (response.requiere_entrada_salida) {
                                const isEntrada = (movimiento === 'ENTRADA');
                                
                                buttonText = isEntrada ? 'Marcar ENTRADA' : 'Marcar SALIDA';
                                buttonColor = isEntrada ? 'bg-green-600 hover:bg-green-700 shadow-green-500/30' : 'bg-orange-600 hover:bg-orange-700 shadow-orange-500/30';
                                buttonIcon = isEntrada ? 
                                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 102 0V7a1 1 0 10-2 0v3zm0 4a1 1 0 102 0v-1a1 1 0 10-2 0v1z" clip-rule="evenodd" /></svg>' :
                                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-8a1 1 0 10-2 0v1a1 1 0 102 0v-1zm-1-4a1 1 0 10-2 0v3a1 1 0 102 0V6z" clip-rule="evenodd" /></svg>';

                            } else {
                                buttonText = 'Confirmar ASISTENCIA';
                                buttonColor = 'bg-red-600 hover:bg-red-700 shadow-red-500/30';
                                buttonIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>';
                            }
                            
                            buttonHtml = `
                                <button type="submit" 
                                            class="w-full py-2.5 ${buttonColor} text-white font-extrabold rounded-full transition duration-300 shadow-xl
                                                flex items-center justify-center px-5 uppercase tracking-wider transform hover:scale-[1.03] active:scale-95">
                                    <div class="flex items-center">
                                        ${buttonIcon}
                                        <span class="text-xs">${buttonText}</span>
                                    </div>
                                </button>
                            `;

                            movimientoDisplay.innerHTML = buttonHtml;
                            openModal();
                        } else {
                            alert('⚠️ Error de Búsqueda: ' + response.message); 
                            dniInput.value = '';
                        }
                    },
                    error: function(xhr) {
                        alert('❌ Error de conexión con el servidor. Código: ' + xhr.status + (xhr.status === 404 ? ' (Ruta no encontrada)' : ''));
                    },
                    complete: function() {
                        searchButton.prop('disabled', false);
                        searchButtonText.textContent = 'Buscar Candidato (ENTER)';
                        dniInput.focus();
                    }
                });
            });

            // Lógica para interceptar ENTER/Tab
            dniInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault(); 
                    if (dniInput.value.trim().length >= 8) {
                        $('#dni-search-form').submit(); 
                    }
                }
            });

            // Lógica de registro de asistencia (Tu código existente)
            $('#registro-asistencia-form').on('submit', function(e) {
                e.preventDefault(); 
                
                const form = $(this);
                const url = form.attr('action'); 
                const submitButton = form.find('button[type="submit"]');
                const originalHtml = submitButton.html(); 
                
                submitButton.prop('disabled', true).html('<div class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-xs">Registrando...</span></div>');


                $.ajax({
                    url: url,
                    type: 'POST',
                    data: form.serialize(),
                    headers: {
                        'X-CSRFToken': form.find('[name="csrfmiddlewaretoken"]').val(),
                        'X-Requested-With': 'XMLHttpRequest' 
                    },
                    dataType: 'json', 
                    
                    success: function(response) {
                        alert('✅ Registro Exitoso: ' + response.message); 
                        closeModal(); 
                    },
                    
                    error: function(xhr) {
                        let errorMessage = 'Error de conexión/servidor.';
                        
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage = response.message || errorMessage;
                        } catch (e) {
                            if (xhr.status === 403) {
                                errorMessage = 'ERROR DE AUTORIZACIÓN (403): Sesión expirada. Por favor, vuelva a iniciar sesión.';
                            } else {
                                errorMessage = `Error HTTP ${xhr.status}. Posible error en el servidor o formato de respuesta.`;
                            }
                        }
                        
                        alert('❌ Fallo el registro: ' + errorMessage);
                    },
                    
                    complete: function() {
                        submitButton.prop('disabled', false).html(originalHtml);
                    }
                });
            });
            
            window.addEventListener('beforeunload', stopScanner);

        }); 
    </script>
{% endblock extra_js %}