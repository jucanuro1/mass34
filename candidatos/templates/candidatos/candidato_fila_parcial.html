<tr class="bg-white border-b border-gray-100 hover:bg-red-50 transition duration-150" 
    id="fila-candidato-{{ candidato.pk }}">
    <td class="py-3 px-4 font-semibold text-gray-950 whitespace-nowrap">
        <div class="font-medium">{{ candidato.nombres_completos }}</div>
        <div class="text-xs text-gray-500 font-light mt-0.5">DNI: {{ candidato.DNI }}</div>
    </td>
    <td class="py-3 px-4 text-center">
        <div class="flex items-center justify-center space-x-2 bg-gray-100 p-2 rounded-lg border border-gray-200 shadow-inner">
            
            <button type="button"
                    title="Marcar como ASISTIÓ / TARDANZA"
                    data-pk="{{ candidato.pk }}"
                    data-estado="A"
                    class="js-asistencia-btn p-2 rounded-full text-xs font-semibold uppercase 
                            {% if candidato.asistencia_hoy == 'A' or candidato.asistencia_hoy == 'T' %} bg-green-600 text-white shadow-md shadow-green-600/40 {% else %} bg-white text-green-700 hover:bg-green-50 {% endif %} 
                            ring-2 ring-transparent hover:ring-green-400 transition duration-200 transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
            </button>
            
            <button type="button"
                    title="Marcar como FALTÓ"
                    data-pk="{{ candidato.pk }}"
                    data-estado="F"
                    class="js-asistencia-btn p-2 rounded-full text-xs font-semibold uppercase 
                            {% if candidato.asistencia_hoy == 'F' %} bg-red-600 text-white shadow-md shadow-red-600/40 {% else %} bg-white text-red-700 hover:bg-red-50 {% endif %} 
                            ring-2 ring-transparent hover:ring-red-400 transition duration-200 transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
            </button>
        </div>
        <div id="loading-{{ candidato.pk }}" class="hidden mt-1 flex justify-center text-sm text-gray-500">
            Cargando...
        </div>
    </td>
    <td class="py-3 px-4 text-center text-sm font-medium text-gray-700" 
        id="estado-candidato-{{ candidato.pk }}">
        {# Asegúrate de que este método exista y funcione en el objeto anotado #}
        {{ candidato.get_estado_actual_display }}
    </td>
    <td class="py-3 px-4 text-center">
        {# CORRECCIÓN APLICADA AQUÍ: Se eliminó la compleja etiqueta {% with %} #}
        {% if candidato.ultimo_registro %}
            <div class="text-gray-500 text-xs uppercase">
                {{ candidato.ultimo_registro.get_fase_actual_display }} 
            </div>
            <span class="text-xs font-bold px-3 py-1 rounded-full mt-1 inline-block 
                {% if candidato.ultimo_registro.movimiento == 'ENTRADA' %} bg-green-100 text-green-700 ring-1 ring-green-200
                {% elif candidato.ultimo_registro.movimiento == 'SALIDA' %} bg-red-100 text-red-700 ring-1 ring-red-200
                {% else %} bg-yellow-100 text-yellow-700 ring-1 ring-yellow-200
                {% endif %}">
                {{ candidato.ultimo_registro.get_movimiento_display }} 
            </span>
        {% elif candidato.ultima_fase %}
             <div class="text-gray-500 text-xs uppercase">{{ candidato.ultima_fase }}</div>
             <div class="text-gray-400 text-sm font-light">Pendiente</div>
        {% else %}
            <div class="text-gray-400 text-sm font-light">N/A</div>
        {% endif %}
        {# Fin de la corrección #}
    </td>
    <td class="py-3 px-4 text-center text-gray-600 text-xs font-light">
        {% if candidato.ultimo_registro_momento %}
            {{ candidato.ultimo_registro_momento|date:"Y-m-d" }}<br> 
            <span class="font-semibold text-gray-700 text-xs">
                {{ candidato.ultimo_registro_momento|date:"h:i a" }}
            </span>
        {% else %}
            Sin Registros
        {% endif %}
    </td>
    <td class="py-3 px-4 text-center font-extrabold text-gray-900">{{ candidato.total_registros }}</td>
    <td class="py-3 px-4 text-center font-extrabold text-green-700">{{ candidato.total_asistencias_puntuales }}</td>
    <td class="py-3 px-4 text-center font-extrabold text-red-700">{{ candidato.total_faltas }}</td>
    <td class="py-3 px-4 text-center font-extrabold text-yellow-700">{{ candidato.total_tardanzas }}</td>
    <td class="py-3 px-4 text-center">
        <button 
            type="button"
            title="Ver Historial Detallado"
            data-pk="{{ candidato.pk }}"
            class="js-detalle-btn p-2 inline-flex items-center justify-center rounded-full bg-red-50 text-red-600 
                    hover:bg-red-600 hover:text-white hover:shadow-lg shadow-red-500/20 
                    transition duration-200 transform active:scale-90">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
        </button>
    </td>
</tr>