{% load static %}
<div class="kanban-col bg-white rounded-xl shadow-lg border-t-4 {{ color }} overflow-hidden flex flex-col w-80 flex-shrink-0">
    
    <h3 class="p-4 text-sm font-bold text-gray-800 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
        <span>
            {{ title }} (<span id="count-{{ status_key }}">{{ data|length }}</span>)
        </span>
        
        <a href="{% url 'exportar_candidatos_excel' estado=status_key %}" 
            class="text-blue-600 hover:text-blue-800 ml-2 p-1 rounded-full hover:bg-gray-200 transition duration-150" 
            title="Exportar '{{ title }}' a Excel">
            
            <svg class="inline w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
        </a>
    </h3>
    
    {# CLASE Y DATA-STATUS NECESARIOS PARA EL DRAG AND DROP #}
    <div id="column-{{ status_key }}" 
        data-status="{{ status_key }}"
        class="p-3 space-y-4 min-h-[300px] max-h-[70vh] overflow-y-auto kanban-column-body flex-grow" 
        ondragover="allowDrop(event)" 
        ondrop="drop(event)">
        
        {% for item in data %}
        {% with proceso=item.proceso candidato=item.candidato %}
        
        {# >>> SOLUCIÓN PARA SELECCIÓN: onclick y ondblclick <<< #}
        <div class="kanban-card bg-white p-4 rounded-lg shadow-md border-l-4 border-{{ color|slice:"7:"|default:'red-500' }}/70 hover:shadow-xl transition duration-150 cursor-pointer active:cursor-grabbing relative group"
            
            {# ATRIBUTOS CRÍTICOS PARA JS DE SELECCIÓN Y D&D #}
            data-dni="{{ candidato.DNI }}" 
            data-candidato-id="{{ candidato.pk }}"
            data-proceso-id="{{ proceso.pk|default:'None' }}" 
            
            {# Datos necesarios para el modal de edición/detalle #}
            data-proceso-estado="{{ candidato.estado_actual }}"
            data-proceso-empresa="{{ proceso.empresa_proceso.nombre|default:'' }}"
            data-proceso-supervisor="{{ proceso.supervisor.nombre|default:'' }}"
            data-proceso-objetivo="{{ proceso.objetivo_ventas_alcanzado|yesno:'true,false,false' }}"
            data-proceso-actitud="{{ proceso.factor_actitud_aplica|yesno:'true,false,false' }}"
            
            draggable="true" 
            ondragstart="drag(event)"
            
            {# CLIC SIMPLE: SELECCIONAR. Es la acción predeterminada. #}
            onclick="toggleCardSelection(this)"

            {# DOBLE CLIC: Abrir el Detalle/Modal (Acción de "Editar" que queremos evitar con un solo clic) #}
            {% if proceso %}
            ondblclick="openUpdateProcessModal(
                '{{ proceso.pk }}', 
                '{{ candidato.nombres_completos }}', 
                '{{ candidato.estado_actual }}', 
                '{{ proceso.empresa_proceso.nombre|default:'' }}',
                '{{ proceso.supervisor.nombre|default:'' }}',
                '{{ proceso.objetivo_ventas_alcanzado|yesno:'true,false,false' }}',
                '{{ proceso.factor_actitud_aplica|yesno:'true,false,false' }}'
            )"
            {% else %}
            {# Si no hay proceso, abrir el detalle del candidato #}
            ondblclick="window.location.href='{% url 'detalle_candidato' dni=candidato.DNI %}'"
            {% endif %}
            >
            
            
            {# ICONO DE RELOJ (Historial): Usamos event.stopPropagation() para que no seleccione la tarjeta #}
            <button 
                onclick="event.stopPropagation(); openHistoryModal('{{ candidato.DNI }}', '{{ candidato.nombres_completos }}')"
                class="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition duration-150 z-10"
                title="Ver Historial del Candidato">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>

            {# Contenido de la Tarjeta #}
            <div class="block"> 
                
                <h4 class="text-sm font-semibold text-gray-800 leading-tight truncate pr-8 group-hover:text-blue-600">
                    {{ candidato.nombres_completos }}
                </h4>
                
                <p class="text-xs text-gray-500 mt-1">DNI: <span class="font-medium">{{ candidato.DNI }}</span></p>
                {# Línea de Responsable ELIMINADA por solicitud #}
                <p class="text-xs font-bold text-gray-500 mt-1">Celular: {{ candidato.telefono_whatsapp }}</p>
                
                <div class="mt-2 pt-2 border-t border-dashed border-gray-200 space-y-1">
                    
                    {# 1. Lógica de Alerta para Registrados #}
                    {% if status_key == 'REGISTRADO' and not proceso %}
                        <p class="text-xs text-red-500 font-semibold pt-1">
                            ⚠️ Pendiente de convocar
                        </p>
                        
                    {# 2. Lógica de Proceso Activo #}
                    {% elif proceso %}
                        
                        {# Supervisor solo visible en CAPACITACION_PRACTICA #}
                        {% if status_key == 'CAPACITACION_PRACTICA' %}
                            <p class="text-xs text-gray-700 font-medium">Supervisor: <span class="font-normal">{{ proceso.supervisor.nombre|truncatechars:15 }}</span></p>
                        {% endif %}
                        
                        <p class="text-xs text-gray-700 font-medium">
                            Convocatoria: 
                            <span class="font-bold text-cyan-800">{{ proceso.fecha_inicio|date:"d/m/Y" }}</span>
                        </p>

                        {# Estado del Proceso (SOLICITADO) #}
                        <p class="text-xs text-gray-700 font-medium">Estado Proceso: <span class="font-semibold px-2 py-0.5 rounded-full text-xs" 
                            {% if proceso.estado == 'INICIADO' %}
                                style="background-color: #fcefd4; color: #b47f00;"
                            {% elif proceso.estado == 'TEORIA' %}
                                style="background-color: #e5f1ff; color: #2563eb;"
                            {% elif proceso.estado == 'PRACTICA' %}
                                style="background-color: #e5ffe8; color: #059669;"
                            {% else %}
                                style="background-color: #f3f4f6; color: #6b7280;"
                            {% endif %}>
                            {{ item.proceso_status }}</span>
                        </p>

                    {% endif %}
                </div>

                {# Botones de acción al final: SOLO DEJAMOS EL BOTÓN "CONVOCAR" #}
                <div class="mt-3 pt-3 border-t border-gray-100 flex justify-end items-center">
                    
                    {% if status_key == 'REGISTRADO' %}
                        <button 
                            onclick="event.stopPropagation(); openConvocarModal('{{ candidato.DNI }}', '{{ candidato.nombres_completos }}')"
                            class="text-xs font-semibold px-2 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-150 shadow-sm"
                            title="Iniciar Proceso de Convocatoria">
                            📞 Convocar
                        </button>
                    {% endif %}
                    
                </div>
            </div> 

        </div>
        {% endwith %}
        {% empty %}
        <div class="text-center py-6 text-gray-500 text-sm">
            No hay candidatos en este estado.
        </div>
        {% endfor %}
    </div>
</div>