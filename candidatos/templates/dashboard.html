{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard | +34 Elite{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-4">
    
    <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-100 pb-4">
    
        <div class="flex items-center w-full md:w-auto mb-4 md:mb-0">
            
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight mr-8">
                Panel <span class="title-gradient">Administración</span>
            </h1>

            <div class="hidden sm:flex items-center space-x-3 border-l border-gray-200 pl-6">
                <a href="{% url 'registro_candidato' %}" 
                title="Registro Rápido de Candidato"
                class="btn-icon-red flex items-center justify-center p-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>
                    </svg>
                </a>
                <a href="{% url 'registro_publico_completo' %}" 
                title="Acceder a Formulario Público"
                target="_blank" 
                class="btn-icon-red flex items-center justify-center p-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L13 7"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L11 17"/>
                    </svg>
                </a>
                <div class="relative flex items-center bg-gray-100 border border-gray-200 rounded-full p-1 shadow-sm">
                    {% url 'registro_publico_completo' as public_registration_path %}
                    {% with request.scheme as scheme %}
                    {% with request.get_host as host_name %}
                        {% with absolute_url=scheme|add:'://'|add:host_name|add:public_registration_path %}

                            <button type="button" 
                                    onclick="copyLink(this, '{{ absolute_url }}')" 
                                    title="Copiar URL Pública"
                                    id="copy-button"
                                    class="btn-icon-red flex items-center justify-center p-3 transition-all duration-200 relative">
                                
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                                </svg>
                                
                                <span id="copy-message" 
                                    class="absolute -top-6 px-3 py-1 text-xs whitespace-nowrap bg-green-500 text-white rounded-full 
                                            opacity-0 pointer-events-none transition-opacity duration-300">
                                    ¡Copiado! ✅
                                </span>
                            </button>

                        {% endwith %} 
                    {% endwith %} 
                    {% endwith %}
                </div>

            </div>
        </div>
        <div class="relative w-full md:w-64">
            <input type="text" 
                id="dni-search" 
                placeholder="Buscar por DNI o Nombre..." 
                class="w-full text-sm pl-10 pr-4 py-2.5 
                    bg-white border border-gray-300 rounded-full 
                    focus:ring-2 focus:ring-corporate-red focus:border-corporate-red 
                    transition duration-300 shadow-lg hover:shadow-xl focus:shadow-red-200">
            
            <svg class="w-5 h-5 text-corporate-red absolute left-3 top-1/2 transform -translate-y-1/2" 
                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
        </div>
    </header>

    {% if messages %}
        <div class="mt-4" id="message-container">
            {% for message in messages %}
                <div class="p-3 mb-2 rounded-lg text-sm flex justify-between items-center transition-opacity duration-500 message-alert {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}" role="alert">
                    {{ message }}
                    
                    <button type="button" class="ml-4 -mr-1 p-1 rounded-full hover:opacity-75 close-button" 
                        aria-label="Close" 
                        onclick="this.closest('.message-alert').style.display='none';"
                        {% if message.tags == 'success' %}
                            style="color: #065f46;"
                        {% elif message.tags == 'error' %}
                            style="color: #991b1b;"
                        {% else %}
                            style="color: #a16207;"
                        {% endif %}
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    <div class="mb-4 bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-100/80 transition-all duration-300"> 
        <div class="p-3 flex justify-between items-center bg-gray-50 hover:bg-gray-100 cursor-pointer select-none border-b border-gray-100" 
            id="toggle-header">
            <h2 class="text-xl font-medium text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <span class="font-bold text-gray-900 tracking-tight">Filtro de Convocatorias</span> 
                <span class="ml-3 text-sm font-light hidden sm:inline">
                    {% if active_date %}
                        <span class="text-red-700 font-semibold">Fecha Activa: {{ active_date|date:"d M Y" }}</span>
                    {% else %}
                        <span class="text-gray-500">Selección rápida por fecha</span>
                    {% endif %}
                </span>
            </h2>
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-4">
                    <button type="button" id="btn-gestionar-candidatos"
                        class="inline-flex justify-center items-center p-3 text-sm bg-white rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-200 transition duration-200 transform hover:scale-105 active:scale-100"
                        data-modal-target="candidatos-modal"
                        title="Gestionar visibilidad de Candidatos por Fecha de Registro">
                        
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                    
                    <button type="button" id="btn-gestionar-convocatorias"
                        class="inline-flex justify-center items-center p-3 text-sm bg-white rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-200 transition duration-200 transform hover:scale-105 active:scale-100"
                        data-modal-target="convocatorias-modal"
                        title="Opciones de Configuración y Filtros del Kanban">
                        
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
                <div class="relative inline-block text-left hidden">
                    <button type="button" id="menu-button" aria-expanded="false" aria-haspopup="true"
                        class="inline-flex justify-center items-center p-1.5 text-sm text-gray-400 bg-white border border-gray-200 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 6a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                    </button>
                    <div id="dropdown-menu" class="absolute right-0 z-10 mt-2 w-56 hidden origin-top-right rounded-lg bg-white shadow-xl ring-1 ring-black ring-opacity-5" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <div class="py-1" role="none">

                            {% with filter_date=request.GET.fecha_inicio %}
                            <form method="POST" action="{% url 'desactivar_convocatoria' %}">
                                {% csrf_token %}
                                
                                {% if filter_date %}
                                    <input type="hidden" name="fecha_filtro" value="{{ filter_date }}">
                                {% endif %}
                                
                                <button type="submit" 
                                        class="text-cyan-900 block w-full text-left px-4 py-2 text-sm hover:bg-red-600 hover:text-white hover:font-medium transition-colors disabled:opacity-75 disabled:cursor-not-allowed" 
                                        role="menuitem" 
                                        tabindex="-1" 
                                        id="menu-item-0"
                                        {% if not filter_date %}disabled title="Selecciona una fecha para desactivar"{% endif %}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2 align-text-bottom" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                    </svg>
                                    Desactivar
                                </button>
                            </form>
                            {% endwith %}

                        </div>
                    </div>
                </div>

                <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden text-gray-400 transition-transform duration-300 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </div>
        
        <div class="p-5" id="collapsible-content"> 
            <p class="text-xs text-gray-500 mb-3 font-medium">Filtra a los candidatos por la fecha en la que iniciaron su convocatoria:</p>
            
            <div class="flex flex-wrap gap-x-2 gap-y-2" id="convocatoria-filters">
                
                {% url 'kanban_dashboard' as all_url %}
                <a href="{{ all_url }}"
                    class="flex items-center px-3 py-1 text-xs font-semibold rounded-full transition duration-200 border transform hover:scale-[1.03]
                    {% if not active_date %} 
                        /* ACTIVO: Fondo rojo oscuro, texto blanco, SOMBREAO */
                        bg-red-700 text-white shadow-lg shadow-red-300/50 border-red-700 
                    {% else %} 
                        /* INACTIVO: Fondo sutil, borde rojo al hacer hover */
                        bg-gray-100 text-gray-600 border-gray-200 hover:bg-red-50 hover:text-red-700 hover:border-red-300
                    {% endif %}">
                    
                    <span class="mr-2">Todas</span> 
                    <span class="px-1.5 py-0.5 text-xs font-extrabold rounded-full 
                        {% if not active_date %} 
                            /* Contador Activo */
                            bg-white/30 text-white 
                        {% else %} 
                            /* Contador Inactivo */
                            bg-white text-red-700 
                        {% endif %}">
                        {{ total_candidatos }}
                    </span>
                </a>

                {% for date_obj in convocatoria_dates %}
                    {% with date_str=date_obj.fecha_inicio|date:"Y-m-d" %}
                        {% url 'kanban_dashboard' as base_url %}
                        {% with filter_url=base_url|add:"?fecha_inicio="|add:date_str %}
                            
                            <a href="{{ filter_url }}" 
                                class="flex items-center px-3 py-1 text-xs font-medium rounded-full transition duration-150 border transform hover:scale-[1.02]
                                {% if active_date|date:"Y-m-d" == date_str %} 
                                    /* ACTIVO: Fondo rojo oscuro, texto blanco, SOMBREAO */
                                    bg-red-700 text-white shadow-md shadow-red-300/50 border-red-700 font-semibold
                                {% else %} 
                                    /* INACTIVO: Fondo sutil, borde rojo al hacer hover */
                                    bg-gray-50 text-gray-700 border-gray-200 hover:bg-red-50 hover:text-red-700
                                {% endif %}">
                                
                                {{ date_obj.fecha_inicio|date:"d/M" }} 
                                <span class="ml-2 px-1.5 py-0.5 text-xs font-bold rounded-full 
                                    {% if active_date|date:"Y-m-d" == date_str %} 
                                        /* Contador Activo */
                                        bg-white/30 text-white 
                                    {% else %} 
                                        /* Contador Inactivo */
                                        bg-gray-200 text-gray-800 
                                    {% endif %}">
                                    {{ date_obj.count }}
                                </span>
                            </a>
                        {% endwith %}
                    {% endwith %}
                {% endfor %} 
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
        {% include "kanban_column.html" with status_key='REGISTRADO' title='1. Registrado' color='border-red-500' data=kanban_data.REGISTRADO %}
        {% include "kanban_column.html" with status_key='CONVOCADO' title='2. Convocado' color='border-indigo-500' data=kanban_data.CONVOCADO %}
        {% include "kanban_column.html" with status_key='CAPACITACION_TEORICA' title='3. Teoría' color='border-yellow-500' data=kanban_data.CAPACITACION_TEORICA %}
        {% include "kanban_column.html" with status_key='CAPACITACION_PRACTICA' title='4. Práctica' color='border-orange-500' data=kanban_data.CAPACITACION_PRACTICA %}
        {% include "kanban_column.html" with status_key='CONTRATADO' title='5. Contratado' color='border-green-500' data=kanban_data.CONTRATADO %}
    </div>
</div>

<div id="initProcessModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                 border-t-4 border-red-700/80 hover:shadow-red-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-red-100 rounded-full mb-3 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                ¡Iniciar Proceso de Convocatoria! </h3>
            
            <button type="button" onclick="closeInitProcessModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-red-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-red-100 pb-3 font-medium uppercase tracking-wider">
            Candidato: 
            <span id="init-candidato-nombre" class="font-bold text-gray-800 ml-1"></span> 
            <span id="init-candidato-dni" class="font-light text-red-600"></span>
        </p>

        <form method="post" action="{% url 'iniciar_proceso' dni='DNI_PLACEHOLDER' %}" id="initProcessForm">
            {% csrf_token %}
            
            <div class="mb-8">
                <label for="id_fecha_inicio" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Fecha de Convocatoria/Inicio de Fase
                    </label>
                <div class="relative">
                    <input type="date" name="fecha_inicio" id="id_fecha_inicio" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-red-700
                               focus:ring-0 focus:border-red-700 transition duration-300 bg-gray-50 hover:bg-white custom-date-input" 
                        required>
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-2">
                
                <button type="button" onclick="closeInitProcessModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 hover:border-gray-400 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-red-700 text-white rounded-full 
                           hover:bg-red-800 transition duration-300 shadow-xl shadow-red-500/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>Iniciar Proceso</span> </button>
            </div>
        </form>
    </div>
</div>

<div id="assignSupervisorIndividualModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-orange-600/80 hover:shadow-orange-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-orange-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v8a2 2 0 002 2h5M18 6h5m-5 0v1.5a2.5 2.5 0 01-5 0V6h5zm0 0a2.5 2.5 0 00-5 0V6h5zm-8 12a2 2 0 100-4 2 2 0 000 4z" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                Asignar Supervisor/Formador
            </h3>
            
            <button type="button" onclick="closeAssignSupervisorIndividualModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-orange-100 pb-3 font-medium uppercase tracking-wider">
            Candidato en Teórica: 
            <span id="assign-candidato-nombre" class="font-bold text-gray-800 ml-1"></span> 
        </p>

        <form method="post" action="{% url 'asignar_supervisor_individual' proceso_id=0 %}" id="assignSupervisorIndividualForm">
            {% csrf_token %}
            <input type="hidden" name="proceso_id" id="assign-proceso-id">
            
            <div class="mb-8">
                <label for="id_supervisor_id_individual" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Seleccionar Supervisor/Formador
                </label>
                <div class="relative">
                    <select name="supervisor_id" id="id_supervisor_id_individual" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-orange-700 appearance-none 
                               focus:ring-0 focus:border-orange-700 transition duration-300 bg-gray-50 hover:bg-white cursor-pointer" 
                        required>
                        <option value="" class="font-medium text-gray-500">--- Seleccione Supervisor/Formador ---</option>
                        {% for supervisor in supervisores %}
                            <option value="{{ supervisor.pk }}">{{ supervisor.nombre }}</option>
                        {% endfor %}
                    </select>
                    
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-2">
                
                <button type="button" onclick="closeAssignSupervisorIndividualModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 hover:border-gray-400 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-orange-600 text-white rounded-full 
                           hover:bg-orange-700 transition duration-300 shadow-xl shadow-orange-500/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    <span>Asignar y a Práctica</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div id="massConvocatoriaModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-red-700/80 hover:shadow-red-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-red-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-2.236-2.839m0 0a1.905 1.905 0 010-3.322m-2.236 2.839L7 18m2-2.236L7 18M11 12a1.905 1.905 0 00-3.322-1.857M11 12a1.905 1.905 0 013.322 1.857M14 12h.01M17 12h.01M7 12h.01M17 12h.01M17 12h.01" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                Asignación Masiva: Convocatoria
            </h3>
            
            <button type="button" onclick="closeMassConvocatoriaModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-red-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-red-100 pb-3 font-medium uppercase tracking-wider">
            Se moverán <span id="mass-convocatoria-count" class="font-bold text-red-700">0</span> candidatos de **REGISTRADO** a **CONVOCADO**.
        </p>

        <form id="massConvocatoriaForm">
            {% csrf_token %}
            <input type="hidden" name="new_status" value="CONVOCADO">
            <input type="hidden" name="dnis" id="mass-convocatoria-dnis">
            
            <div class="mb-8">
                <label for="id_mass_fecha_inicio" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Fecha de Inicio para el Bloque
                </label>
                <div class="relative">
                    <input type="date" name="fecha_inicio" id="id_mass_fecha_inicio" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-red-700
                               focus:ring-0 focus:border-red-700 transition duration-300 bg-gray-50 hover:bg-white custom-date-input" 
                        required>
                    
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-2">
                
                <button type="button" onclick="closeMassConvocatoriaModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 hover:border-gray-400 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-red-700 text-white rounded-full 
                           hover:bg-red-800 transition duration-300 shadow-xl shadow-red-500/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                         <path d="M13 7h-2.586l-2.707 2.707a1 1 0 00-1.414 0l-4 4a1 1 0 00.707 1.707h.586l.707.707a1 1 0 001.414 0l4-4a1 1 0 000-1.414l-2.707-2.707H13V15a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" fill-rule="evenodd" />
                    </svg>
                    <span>Mover Bloque</span>
                </button>
            </div>
        </form>
    </div>
</div>

 <div id="massAssignSupervisorModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">

    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">

        <h3 class="text-xl font-bold text-orange-600 mb-4">Asignación Masiva: Supervisor para Práctica</h3>

        <p class="text-gray-700 mb-4">Se moverán <span id="mass-supervisor-count" class="font-semibold text-orange-700">0</span> candidatos de **TEORÍA** a **PRÁCTICA**.</p>



        <form id="massAssignSupervisorForm">

            {% csrf_token %}

            <input type="hidden" name="new_status" value="CAPACITACION_PRACTICA">

            <input type="hidden" name="dnis" id="mass-supervisor-dnis">

           

            <div class="mb-4">

                <label for="id_mass_supervisor_id" class="block text-sm font-medium text-gray-700">Supervisor/Formador para el Bloque de Práctica:</label>

                <select name="supervisor_id" id="id_mass_supervisor_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>

                    <option value="">Seleccione Supervisor</option>

                    {% for supervisor in supervisores %}

                        <option value="{{ supervisor.pk }}">{{ supervisor.nombre }}</option>

                    {% endfor %}

                </select>

            </div>



            <div class="flex justify-end space-x-3">

                <button type="button" onclick="closeMassAssignSupervisorModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cancelar</button>

                <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition duration-150">Asignar a Bloque y Mover</button>

            </div>

        </form>

    </div>

</div>

<div id="updateProcessModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-yellow-600/80 hover:shadow-yellow-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-yellow-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-6 w-6 text-yellow-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                Actualizar Proceso y Resultado
            </h3>
            
            <button type="button" onclick="closeUpdateProcessModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-yellow-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-yellow-100 pb-3 font-medium uppercase tracking-wider">
            Candidato: <span id="update-candidato-nombre" class="font-bold text-gray-800 ml-1"></span>
            <span class="mx-1 text-gray-300">|</span>
            Proceso: <span id="update-empresa-nombre" class="font-bold text-gray-800"></span>
        </p>

        <form method="post" action="{% url 'actualizar_proceso' proceso_id=0 %}" id="updateProcessForm">
            {% csrf_token %}
            <input type="hidden" name="proceso_id" id="update-proceso-id">
            
            <div class="mb-5">
                <label for="id_estado_proceso_update" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Nuevo Estado del Proceso
                </label>
                <div class="relative">
                    <select name="estado_proceso" id="id_estado_proceso_update" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-yellow-700 appearance-none 
                               focus:ring-0 focus:border-yellow-700 transition duration-300 bg-gray-50 hover:bg-white cursor-pointer" 
                        required>
                        <option value="" class="font-medium text-gray-500">--- Seleccione el Estado Final ---</option>
                        {% for key, value in Proceso.ESTADOS_PROCESO %}
                            <option value="{{ key }}">{{ value }}</option>
                        {% endfor %}
                    </select>
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="border border-yellow-100 bg-yellow-50/50 p-4 rounded-xl space-y-3 mb-6" id="performance-fields" style="display:none;">
                <p class="font-bold text-[11px] text-yellow-800 uppercase tracking-wider border-b border-yellow-200 pb-2">Resultados Finales:</p>
                
                <div class="flex items-center">
                    <input type="checkbox" name="objetivo_ventas_alcanzado" id="id_objetivo_ventas_alcanzado" 
                           class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                    <label for="id_objetivo_ventas_alcanzado" class="text-xs font-medium text-gray-700 ml-2 select-none">¿Alcanzó Objetivo/KPIs de ventas?</label>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" name="factor_actitud_aplica" id="id_factor_actitud_aplica"
                           class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                    <label for="id_factor_actitud_aplica" class="text-xs font-medium text-gray-700 ml-2 select-none">¿Aplica Contratación por Factor Actitud?</label>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeUpdateProcessModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-yellow-600 text-white rounded-full 
                           hover:bg-yellow-700 transition duration-300 shadow-xl shadow-yellow-400/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v5a1 1 0 102 0V7z" clip-rule="evenodd" />
                    </svg>
                    <span>Finalizar/Actualizar</span>
                </button>
            </div>
        </form>
    </div>
</div>
<div id="historyModal" 
      class="fixed inset-0 bg-gray-900 bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 relative"> <div class="p-6 bg-red-600 rounded-t-2xl flex justify-between items-center">
            <h3 class="text-md font-extrabold text-white flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-red-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2h2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v2M7 7h10" />
                </svg>
                Historial de Convocatorias y Procesos
            </h3>
            <button type="button" onclick="closeHistoryModal()" 
                class="absolute top-3 right-3 p-2 text-white hover:text-red-200 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        
        <div class="p-6">
            <p class="text-sm text-green-700 font-semibold mb-4 pb-2 border-b border-red-600">
                Candidato: <span id="history-candidato-nombre" class="font-extrabold text-cyan-800"></span> 
                (<span id="history-candidato-dni" class="font-bold text-blue-600"></span>)
            </p>

            <div id="history-content" class="max-h-96 overflow-y-auto space-y-4">
                <p class="text-center text-gray-500 py-4">Cargando historial...</p>
            </div>
        </div>

        <div class="flex justify-end p-4 border-t border-red-600 bg-gray-50 rounded-b-2xl">
            <button type="button" onclick="closeHistoryModal()" 
                            class="px-6 py-2 border border-red-600 rounded-full text-red-600 hover:bg-red-600 hover:text-white transition duration-200 shadow-md">
                Cerrar
            </button>
        </div>
    </div>
</div>
<button id="btn-mass-action" class="fixed bottom-5 right-5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition duration-300"style="display: none;">
    Acción Masiva 
    <span id="selected-count" class="ml-1 px-2 py-1 bg-white text-blue-600 rounded-full text-xs font-black">
        0
    </span>
</button>

<div id="mass-action-menu" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-100 hidden">
    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
        <h3 class="text-xl font-bold mb-4">Acción Masiva (Descarte)</h3>
        <p class="mb-4">Vas a descartar a <span id="menu-selected-count" class="font-bold">0</span> candidatos.</p>
        
        <div class="hidden"> 
            <label for="descarte-motivo-select" class="block text-sm font-medium text-gray-700">Motivo de Descarte</label>
            <select id="descarte-motivo-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                 <option value="DESISTE" selected>Desiste (Fijo)</option> 
            </select>
        </div>
        
        <p class="text-sm text-red-600 font-semibold mt-4">La acción de descarte masivo aplicará el motivo por defecto.</p>

        <div class="mt-6 flex justify-end space-x-3">
            <button onclick="closeMassActionMenu()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md">Cancelar</button>
            
            <button onclick="confirmMassDescarte('DESISTE')" 
                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md">
                Confirmar Descarte
            </button>
        </div>
    </div>
</div>

<div id="massActionMenu" class="hidden fixed bottom-20 right-5 p-4 bg-white border rounded shadow-lg z-50">
    <p class="font-bold mb-2">Mover Seleccionados a:</p>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CONVOCADO'); closeMassActionMenu();">CONVOCADO</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CAPACITACION_TEORICA'); closeMassActionMenu();">CAP. TEÓRICA</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CAPACITACION_PRACTICA'); closeMassActionMenu();">CAP. PRÁCTICA</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CONTRATADO'); closeMassActionMenu();">CONTRATADO</button>
</div>
<div id="convocatorias-modal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-gray-900 bg-opacity-50" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-5xl transition-all transform duration-300 scale-95 opacity-0" 
             id="modal-content-area-convocatorias">
            
            <div class="p-5 text-center">
                <p class="text-gray-500">Cargando gestión de convocatorias...</p>
            </div>
            
        </div>
    </div>
</div>
<div id="candidatos-modal" 
     class="fixed inset-0 bg-gray-900 bg-opacity-70 backdrop-blur-sm z-50 hidden transition-opacity" 
     tabindex="-1">
    
    <div class="flex items-center justify-center min-h-screen p-4">
        
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all duration-300 scale-95" 
             id="candidatos-modal-inner">
             
            <div class="px-6 py-4 flex justify-between items-center bg-red-600 rounded-t-2xl shadow-lg">
                
                <h3 class="text-xl font-extrabold text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-red-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.456-.279-.86-.687-1.037M17 20a2 2 0 012 2h3m-5.856-2.857l-1.42 1.42a2 2 0 01-2.83-2.83l1.42-1.42M12 10a5 5 0 01-5-5h10a5 5 0 01-5 5z" />
                    </svg>
                    Gestión de candidatos registrados
                </h3>
                
                <button type="button" 
                        data-modal-close 
                        class="text-red-200 hover:text-white transition-colors p-1 rounded-full hover:bg-red-700/50 transform active:scale-95" 
                        onclick="closeCandModal('candidatos-modal')">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="candidatos-modal-content" class="min-h-[250px] flex items-center justify-center p-6">
                 <p class="text-gray-500 font-semibold text-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 animate-spin text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356-2A8.001 8.001 0 005.636 5.636l1.01-1.01m-2.828 2.828l1.01 1.01M20 10V5h-1.582M12 2v4M12 18v4M4 12h4M16 12h4" /></svg>
                     Cargando fechas de registro...
                </p>
            </div>
            
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
        <script>
            const AppConfig = {
                updateUrl: "{% url 'update_candidato_status' %}",
                massiveUpdateUrl: "{% url 'update_candidato_status_multiple' %}",
                API_ASISTENCIA_CHECK_URL: "{% url 'api_asistencia_check' %}",
                historyApiUrl: "{% url 'api_candidato_historial' dni='DNI_PLACEHOLDER' %}",
                gestionConvocatoriasUrl: "{% url 'gestion_convocatorias' %}",
                listaCandidatosPorFechaUrl: "{% url 'lista_candidatos_por_fecha' %}",
                csrfToken: "{{ csrf_token }}"
            };
        </script>
        <script src="{% static 'js/dashboard.js' %}"></script>
{% endblock extra_js %}