{% extends "base.html" %}
{% block title %}Dashboard | +34 Elite{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-100 pb-4">
    
        <div class="flex items-center w-full md:w-auto mb-4 md:mb-0">
            
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight mr-8">
                Panel <span class="title-gradient">Administración</span>
            </h1>

            <div class="hidden sm:flex items-center space-x-3 border-l border-gray-200 pl-6">
                
                <a href="{% url 'registro_candidato' %}" 
                title="Registro Rápido de Candidato"
                class="btn-icon-red flex items-center justify-center p-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>
                    </svg>
                </a>

                <a href="{% url 'registro_publico_completo' %}" 
                title="Acceder a Formulario Público"
                target="_blank" 
                class="btn-icon-red flex items-center justify-center p-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L13 7"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L11 17"/>
                    </svg>
                </a>

                <div class="relative flex items-center bg-gray-100 border border-gray-200 rounded-full p-1 shadow-sm">
                    {% url 'registro_publico_completo' as public_registration_path %}
                    {% with request.scheme as scheme %}
                    {% with request.get_host as host_name %}

                        {% with absolute_url=scheme|add:'://'|add:host_name|add:public_registration_path %}

                            <button type="button" 
                                    onclick="copyLink(this, '{{ absolute_url }}')" 
                                    title="Copiar URL Pública"
                                    id="copy-button"
                                    class="btn-icon-red flex items-center justify-center p-3 transition-all duration-200 relative">
                                
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                                </svg>
                                
                                <span id="copy-message" 
                                    class="absolute -top-10 px-3 py-1 text-xs whitespace-nowrap bg-green-500 text-white rounded-full 
                                            opacity-0 pointer-events-none transition-opacity duration-300">
                                    ¡Copiado! ✅
                                </span>
                            </button>

                        {% endwith %} 
                    {% endwith %} 
                    {% endwith %}
                </div>

            </div>
        </div>
        <div class="relative w-full md:w-64">
            <input type="text" 
                id="dni-search" 
                placeholder="Buscar por DNI o Nombre..." 
                class="w-full text-sm pl-10 pr-4 py-2.5 
                    bg-white border border-gray-300 rounded-full 
                    focus:ring-2 focus:ring-corporate-red focus:border-corporate-red 
                    transition duration-300 shadow-lg hover:shadow-xl focus:shadow-red-200">
            
            <svg class="w-5 h-5 text-corporate-red absolute left-3 top-1/2 transform -translate-y-1/2" 
                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
        </div>
    </header>

    {% if messages %}
        <div class="mt-4" id="message-container">
            {% for message in messages %}
                <div class="p-3 mb-2 rounded-lg text-sm flex justify-between items-center transition-opacity duration-500 message-alert {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}" role="alert">
                    {{ message }}
                    
                    <button type="button" class="ml-4 -mr-1 p-1 rounded-full hover:opacity-75 close-button" 
                        aria-label="Close" 
                        onclick="this.closest('.message-alert').style.display='none';"
                        {% if message.tags == 'success' %}
                            style="color: #065f46;"
                        {% elif message.tags == 'error' %}
                            style="color: #991b1b;"
                        {% else %}
                            style="color: #a16207;"
                        {% endif %}
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="mb-8 bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-100/80 transition-all duration-300">
        
        <div class="p-5 flex justify-between items-center bg-gray-50 hover:bg-gray-100 cursor-pointer select-none border-b border-gray-100" 
            id="toggle-header">
            
            <h2 class="text-xl font-medium text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <span class="font-bold text-gray-900 tracking-tight">Filtro de Convocatorias</span> 
                
                <span class="ml-3 text-sm font-light hidden sm:inline">
                    {% if active_date %}
                        <span class="text-red-700 font-semibold">Fecha Activa: {{ active_date|date:"d M Y" }}</span>
                    {% else %}
                        <span class="text-gray-500">Selección rápida por fecha</span>
                    {% endif %}
                </span>
            </h2>

            <div class="flex items-center space-x-3">
                <div class="relative inline-block text-left">
                    <button type="button" id="menu-button" aria-expanded="false" aria-haspopup="true"
                        class="inline-flex justify-center items-center p-1.5 text-sm text-gray-400 bg-white border border-gray-200 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 6a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                    </button>
                
                    <div id="dropdown-menu" class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-lg bg-white shadow-xl ring-1 ring-black ring-opacity-5 hidden" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                            <a href="#" class="text-red-700 block px-4 py-2 text-sm hover:bg-red-50 hover:font-medium transition-colors" role="menuitem" tabindex="-1" id="menu-item-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2 align-text-bottom" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                </svg>
                                Desactivar Convocatoria
                            </a>
                        </div>
                    </div>
                </div>

                <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 transition-transform duration-300 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </div>
        
        <div class="p-5" id="collapsible-content"> 
            <p class="text-xs text-gray-500 mb-3 font-medium">Filtra a los candidatos por la fecha en la que iniciaron su convocatoria:</p>
            
            <div class="flex flex-wrap gap-x-2 gap-y-2" id="convocatoria-filters">
                
                {# Botón de TODAS las Fechas #}
                {% url 'kanban_dashboard' as all_url %}
                <a href="{{ all_url }}"
                    class="flex items-center px-3 py-1 text-xs font-semibold rounded-full transition duration-200 border transform hover:scale-[1.03]
                    {% if not active_date %} 
                        /* ACTIVO: Fondo rojo oscuro, texto blanco, SOMBREAO */
                        bg-red-700 text-white shadow-lg shadow-red-300/50 border-red-700 
                    {% else %} 
                        /* INACTIVO: Fondo sutil, borde rojo al hacer hover */
                        bg-gray-100 text-gray-600 border-gray-200 hover:bg-red-50 hover:text-red-700 hover:border-red-300
                    {% endif %}">
                    
                    <span class="mr-2">Todas</span> 
                    <span class="px-1.5 py-0.5 text-xs font-extrabold rounded-full 
                        {% if not active_date %} 
                            /* Contador Activo */
                            bg-white/30 text-white 
                        {% else %} 
                            /* Contador Inactivo */
                            bg-white text-red-700 
                        {% endif %}">
                        {{ total_candidatos }}
                    </span>
                </a>

                {# Loops de Fechas #}
                {% for date_obj in convocatoria_dates %}
                    {% with date_str=date_obj.fecha_inicio|date:"Y-m-d" %}
                        {% url 'kanban_dashboard' as base_url %}
                        {% with filter_url=base_url|add:"?fecha_inicio="|add:date_str %}
                            
                            <a href="{{ filter_url }}" 
                                class="flex items-center px-3 py-1 text-xs font-medium rounded-full transition duration-150 border transform hover:scale-[1.02]
                                {% if active_date|date:"Y-m-d" == date_str %} 
                                    /* ACTIVO: Fondo rojo oscuro, texto blanco, SOMBREAO */
                                    bg-red-700 text-white shadow-md shadow-red-300/50 border-red-700 font-semibold
                                {% else %} 
                                    /* INACTIVO: Fondo sutil, borde rojo al hacer hover */
                                    bg-gray-50 text-gray-700 border-gray-200 hover:bg-red-50 hover:text-red-700
                                {% endif %}">
                                
                                {{ date_obj.fecha_inicio|date:"d/M" }} 
                                <span class="ml-2 px-1.5 py-0.5 text-xs font-bold rounded-full 
                                    {% if active_date|date:"Y-m-d" == date_str %} 
                                        /* Contador Activo */
                                        bg-white/30 text-white 
                                    {% else %} 
                                        /* Contador Inactivo */
                                        bg-gray-200 text-gray-800 
                                    {% endif %}">
                                    {{ date_obj.count }}
                                </span>
                            </a>
                        {% endwith %}
                    {% endwith %}
                {% endfor %} 
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
        {% include "kanban_column.html" with status_key='REGISTRADO' title='1. Registrado' color='border-red-500' data=kanban_data.REGISTRADO %}
        {% include "kanban_column.html" with status_key='CONVOCADO' title='2. Convocado' color='border-indigo-500' data=kanban_data.CONVOCADO %}
        {% include "kanban_column.html" with status_key='CAPACITACION_TEORICA' title='3. Teoría' color='border-yellow-500' data=kanban_data.CAPACITACION_TEORICA %}
        {% include "kanban_column.html" with status_key='CAPACITACION_PRACTICA' title='4. Práctica' color='border-orange-500' data=kanban_data.CAPACITACION_PRACTICA %}
        {% include "kanban_column.html" with status_key='CONTRATADO' title='5. Contratado' color='border-green-500' data=kanban_data.CONTRATADO %}
    </div>
</div>

{# Modals individuales existentes (solo se mantienen, la lógica D&D llama a las funciones) #}

<div id="initProcessModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-red-700/80 hover:shadow-red-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-red-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                ¡Iniciar Convocatoria Ahora!
            </h3>
            
            <button type="button" onclick="closeInitProcessModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-red-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-red-100 pb-3 font-medium uppercase tracking-wider">
            Candidato: 
            <span id="init-candidato-nombre" class="font-bold text-gray-800 ml-1"></span> 
            <span id="init-candidato-dni" class="font-light text-red-600"></span>
        </p>

        <form method="post" action="{% url 'iniciar_proceso' dni='DNI_PLACEHOLDER' %}" id="initProcessForm">
            {% csrf_token %}
            
            <div class="mb-8">
                <label for="id_fecha_inicio" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Fecha de Inicio de Proceso
                </label>
                <div class="relative">
                    <input type="date" name="fecha_inicio" id="id_fecha_inicio" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-red-700
                               focus:ring-0 focus:border-red-700 transition duration-300 bg-gray-50 hover:bg-white custom-date-input" 
                        required>
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-2">
                
                <button type="button" onclick="closeInitProcessModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 hover:border-gray-400 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-red-700 text-white rounded-full 
                           hover:bg-red-800 transition duration-300 shadow-xl shadow-red-500/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>Convocar Candidato</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div id="assignSupervisorIndividualModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-orange-600/80 hover:shadow-orange-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-orange-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v8a2 2 0 002 2h5M18 6h5m-5 0v1.5a2.5 2.5 0 01-5 0V6h5zm0 0a2.5 2.5 0 00-5 0V6h5zm-8 12a2 2 0 100-4 2 2 0 000 4z" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                Asignar Supervisor/Formador
            </h3>
            
            <button type="button" onclick="closeAssignSupervisorIndividualModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-orange-100 pb-3 font-medium uppercase tracking-wider">
            Candidato en Teórica: 
            <span id="assign-candidato-nombre" class="font-bold text-gray-800 ml-1"></span> 
        </p>

        <form method="post" action="{% url 'asignar_supervisor_individual' proceso_id=0 %}" id="assignSupervisorIndividualForm">
            {% csrf_token %}
            <input type="hidden" name="proceso_id" id="assign-proceso-id">
            
            <div class="mb-8">
                <label for="id_supervisor_id_individual" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Seleccionar Supervisor/Formador
                </label>
                <div class="relative">
                    <select name="supervisor_id" id="id_supervisor_id_individual" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-orange-700 appearance-none 
                               focus:ring-0 focus:border-orange-700 transition duration-300 bg-gray-50 hover:bg-white cursor-pointer" 
                        required>
                        <option value="" class="font-medium text-gray-500">--- Seleccione Supervisor/Formador ---</option>
                        {% for supervisor in supervisores %}
                            <option value="{{ supervisor.pk }}">{{ supervisor.nombre }}</option>
                        {% endfor %}
                    </select>
                    
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-2">
                
                <button type="button" onclick="closeAssignSupervisorIndividualModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 hover:border-gray-400 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-orange-600 text-white rounded-full 
                           hover:bg-orange-700 transition duration-300 shadow-xl shadow-orange-500/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    <span>Asignar y a Práctica</span>
                </button>
            </div>
        </form>
    </div>
</div>

{# ------------------------------------------------------------------------------------------------ #}
{# NUEVOS MODALES PARA ACCIÓN MASIVA #}
{# ------------------------------------------------------------------------------------------------ #}

<div id="massConvocatoriaModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-red-700/80 hover:shadow-red-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-red-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-2.236-2.839m0 0a1.905 1.905 0 010-3.322m-2.236 2.839L7 18m2-2.236L7 18M11 12a1.905 1.905 0 00-3.322-1.857M11 12a1.905 1.905 0 013.322 1.857M14 12h.01M17 12h.01M7 12h.01M17 12h.01M17 12h.01" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                Asignación Masiva: Convocatoria
            </h3>
            
            <button type="button" onclick="closeMassConvocatoriaModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-red-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-red-100 pb-3 font-medium uppercase tracking-wider">
            Se moverán <span id="mass-convocatoria-count" class="font-bold text-red-700">0</span> candidatos de **REGISTRADO** a **CONVOCADO**.
        </p>

        <form id="massConvocatoriaForm">
            {% csrf_token %}
            <input type="hidden" name="new_status" value="CONVOCADO">
            <input type="hidden" name="dnis" id="mass-convocatoria-dnis">
            
            <div class="mb-8">
                <label for="id_mass_fecha_inicio" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Fecha de Inicio para el Bloque
                </label>
                <div class="relative">
                    <input type="date" name="fecha_inicio" id="id_mass_fecha_inicio" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-red-700
                               focus:ring-0 focus:border-red-700 transition duration-300 bg-gray-50 hover:bg-white custom-date-input" 
                        required>
                    
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-2">
                
                <button type="button" onclick="closeMassConvocatoriaModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 hover:border-gray-400 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-red-700 text-white rounded-full 
                           hover:bg-red-800 transition duration-300 shadow-xl shadow-red-500/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                         <path d="M13 7h-2.586l-2.707 2.707a1 1 0 00-1.414 0l-4 4a1 1 0 00.707 1.707h.586l.707.707a1 1 0 001.414 0l4-4a1 1 0 000-1.414l-2.707-2.707H13V15a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" fill-rule="evenodd" />
                    </svg>
                    <span>Mover Bloque</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div id="massAssignSupervisorModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-orange-600/80 hover:shadow-orange-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-orange-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-2.236-2.839m0 0a1.905 1.905 0 010-3.322m-2.236 2.839L7 18m2-2.236L7 18M11 12a1.905 1.905 0 00-3.322-1.857M11 12a1.905 1.905 0 013.322 1.857M14 12h.01M17 12h.01M7 12h.01M17 12h.01M17 12h.01" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                Asignación Masiva de Supervisor
            </h3>
            
            <button type="button" onclick="closeMassAssignSupervisorModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-orange-100 pb-3 font-medium uppercase tracking-wider">
            Se moverán <span id="mass-supervisor-count" class="font-bold text-orange-700">0</span> candidatos de **TEORÍA** a **PRÁCTICA** (OJT).
        </p>

        <form id="massAssignSupervisorForm">
            {% csrf_token %}
            <input type="hidden" name="new_status" value="CAPACITACION_PRACICA">
            <input type="hidden" name="dnis" id="mass-supervisor-dnis">
            
            <div class="mb-8">
                <label for="id_mass_supervisor_id" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Seleccionar Supervisor/Formador para el Bloque
                </label>
                <div class="relative">
                    <select name="supervisor_id" id="id_mass_supervisor_id" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-orange-700 appearance-none 
                               focus:ring-0 focus:border-orange-700 transition duration-300 bg-gray-50 hover:bg-white cursor-pointer" 
                        required>
                        <option value="" class="font-medium text-gray-500">--- Seleccione Supervisor/Formador ---</option>
                        {% for supervisor in supervisores %}
                            <option value="{{ supervisor.pk }}">{{ supervisor.nombre }}</option>
                        {% endfor %}
                    </select>
                    
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-2">
                
                <button type="button" onclick="closeMassAssignSupervisorModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 hover:border-gray-400 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-orange-600 text-white rounded-full 
                           hover:bg-orange-700 transition duration-300 shadow-xl shadow-orange-500/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13 7h-2.586l-2.707 2.707a1 1 0 00-1.414 0l-4 4a1 1 0 00.707 1.707h.586l.707.707a1 1 0 001.414 0l4-4a1 1 0 000-1.414l-2.707-2.707H13V15a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" fill-rule="evenodd" />
                    </svg>
                    <span>Asignar y Mover Bloque</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div id="updateProcessModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[1000] backdrop-blur-sm hidden">
    
    <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all duration-300 scale-100 p-8 
                border-t-4 border-yellow-600/80 hover:shadow-yellow-500/20 hover:shadow-xl">
        
        <header class="mb-6 text-center">
            <div class="inline-flex items-center justify-center p-3 bg-yellow-100 rounded-full mb-3 shadow-inner">
                 <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-6 w-6 text-yellow-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
            </div>
            <h3 class="text-lg font-extrabold text-gray-900 leading-snug tracking-tighter">
                Actualizar Proceso y Resultado
            </h3>
            
            <button type="button" onclick="closeUpdateProcessModal()" 
                class="absolute top-4 right-4 p-2 text-gray-400 hover:text-yellow-700 hover:bg-gray-100 rounded-full transition duration-200"
                title="Cerrar">
                <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <p class="text-[10px] text-gray-500 mb-5 border-b border-dashed border-yellow-100 pb-3 font-medium uppercase tracking-wider">
            Candidato: <span id="update-candidato-nombre" class="font-bold text-gray-800 ml-1"></span>
            <span class="mx-1 text-gray-300">|</span>
            Proceso: <span id="update-empresa-nombre" class="font-bold text-gray-800"></span>
        </p>

        <form method="post" action="{% url 'actualizar_proceso' proceso_id=0 %}" id="updateProcessForm">
            {% csrf_token %}
            <input type="hidden" name="proceso_id" id="update-proceso-id">
            
            <div class="mb-5">
                <label for="id_estado_proceso_update" class="block text-xs font-semibold text-gray-700 mb-2 tracking-wide uppercase">
                    Nuevo Estado del Proceso
                </label>
                <div class="relative">
                    <select name="estado_proceso" id="id_estado_proceso_update" 
                        class="block w-full border-b-2 border-gray-300 rounded-none shadow-none p-2 pr-10 text-sm font-semibold text-yellow-700 appearance-none 
                               focus:ring-0 focus:border-yellow-700 transition duration-300 bg-gray-50 hover:bg-white cursor-pointer" 
                        required>
                        <option value="" class="font-medium text-gray-500">--- Seleccione el Estado Final ---</option>
                        {% for key, value in Proceso.ESTADOS_PROCESO %}
                            <option value="{{ key }}">{{ value }}</option>
                        {% endfor %}
                    </select>
                    <span class="absolute right-2 top-2 pointer-events-none">
                        <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
                        </svg>
                    </span>
                </div>
            </div>
            
            <div class="border border-yellow-100 bg-yellow-50/50 p-4 rounded-xl space-y-3 mb-6" id="performance-fields" style="display:none;">
                <p class="font-bold text-[11px] text-yellow-800 uppercase tracking-wider border-b border-yellow-200 pb-2">Resultados Finales:</p>
                
                <div class="flex items-center">
                    <input type="checkbox" name="objetivo_ventas_alcanzado" id="id_objetivo_ventas_alcanzado" 
                           class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                    <label for="id_objetivo_ventas_alcanzado" class="text-xs font-medium text-gray-700 ml-2 select-none">¿Alcanzó Objetivo/KPIs de ventas?</label>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" name="factor_actitud_aplica" id="id_factor_actitud_aplica"
                           class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                    <label for="id_factor_actitud_aplica" class="text-xs font-medium text-gray-700 ml-2 select-none">¿Aplica Contratación por Factor Actitud?</label>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeUpdateProcessModal()" 
                    class="text-xs font-medium px-4 py-2 border border-gray-300 rounded-full text-gray-600 
                           hover:bg-gray-100 transition duration-200 transform hover:scale-[1.02]">
                    Cancelar
                </button>
                
                <button type="submit" 
                    class="text-xs font-extrabold px-5 py-2.5 bg-yellow-600 text-white rounded-full 
                           hover:bg-yellow-700 transition duration-300 shadow-xl shadow-yellow-400/30 
                           flex items-center space-x-1 uppercase tracking-wider transform hover:scale-105 active:scale-95">
                    <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v5a1 1 0 102 0V7z" clip-rule="evenodd" />
                    </svg>
                    <span>Finalizar/Actualizar</span>
                </button>
            </div>
        </form>
    </div>
</div>

<div id="historyModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Historial de Convocatorias y Procesos</h3>
        <p class="text-gray-700 mb-4">Candidato: <span id="history-candidato-nombre" class="font-semibold"></span> (<span id="history-candidato-dni" class="font-semibold"></span>)</p>

        <div id="history-content" class="max-h-96 overflow-y-auto space-y-4">
            <p class="text-center text-gray-500">Cargando historial...</p>
        </div>

        <div class="flex justify-end mt-6">
            <button type="button" onclick="closeHistoryModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cerrar</button>
        </div>
    </div>
</div>

<div id="asistenciaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 justify-center items-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
        <h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">Registro Rápido de Asistencia</h3>
        
        <form id="asistenciaRapidaForm" method="POST" action="{% url 'registrar_asistencia_rapida' %}">
            {% csrf_token %}
            
            <input type="hidden" name="proceso_id" id="asistencia-proceso-id-input" value="">

            <p class="text-gray-700 mb-4">
                ¿Registrar la asistencia de <span id="asistencia-candidato-dni-display" class="font-semibold text-gray-900"></span> para hoy?
            </p>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeAsistenciaModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    Marcar Asistencia
                </button>
            </div>
        </form>
    </div>
</div>
<button 
    id="btn-mass-action" 
    class="hidden fixed bottom-5 right-5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition duration-300"
    onclick="openMassActionMenu()">
    Acción Masiva <span id="selected-count" class="ml-1 px-2 py-1 bg-white text-blue-600 rounded-full text-xs font-black">0</span>
</button>

<div id="massActionMenu" class="hidden fixed bottom-20 right-5 p-4 bg-white border rounded shadow-lg z-50">
    <p class="font-bold mb-2">Mover Seleccionados a:</p>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CONVOCADO'); closeMassActionMenu();">CONVOCADO</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CAPACITACION_TEORICA'); closeMassActionMenu();">CAP. TEÓRICA</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CAPACITACION_PRACTICA'); closeMassActionMenu();">CAP. PRÁCTICA</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CONTRATADO'); closeMassActionMenu();">CONTRATADO</button>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    const updateUrl = "{% url 'update_candidato_status' %}";
    const massiveUpdateUrl = "{% url 'update_candidato_status_multiple' %}";
    const historyApiUrl = "";
    const API_ASISTENCIA_CHECK_URL = "{% url 'api_asistencia_check' %}";
    const csrfToken = "{{ csrf_token }}";

    const STATUS_MAP = {
        'column-REGISTRADO': 'REGISTRADO',
        'column-CONVOCADO': 'CONVOCADO',
        'column-CAPACITACION_TEORICA': 'CAPACITACION_TEORICA',
        'column-CAPACITACION_PRACTICA': 'CAPACITACION_PRACTICA',
        'column-CONTRATADO': 'CONTRATADO'
    };
    
    let selectedCards = [];

    function toggleCardSelection(cardElement) {
        const dni = cardElement.getAttribute('data-dni');
        const procesoId = cardElement.getAttribute('data-proceso-id');

        if (cardElement.classList.contains('dragging')) return;

        if (cardElement.classList.contains('selected')) {
            cardElement.classList.remove('selected', 'border-4', 'border-blue-500', 'ring-2', 'ring-blue-500'); 
            selectedCards = selectedCards.filter(card => card.dni !== dni);
        } else {
            cardElement.classList.add('selected', 'border-4', 'border-blue-500', 'ring-2', 'ring-blue-500');
            selectedCards.push({ dni: dni, proceso_id: procesoId });
        }
        
        const massBtn = document.getElementById('btn-mass-action');
        const selectedCountSpan = document.getElementById('selected-count');
        
        if (selectedCards.length > 0) {
            massBtn.classList.remove('hidden');
            selectedCountSpan.textContent = selectedCards.length;
        } else {
            massBtn.classList.add('hidden');
        }
        
        console.log(`Tarjetas seleccionadas: ${selectedCards.length}`, selectedCards);
    }
    
    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        const draggedDni = event.target.dataset.dni;
        
        if (selectedCards.length === 0) {
            event.dataTransfer.setData("text/mode", "individual");
            event.dataTransfer.setData("text/dni", draggedDni);
            event.dataTransfer.setData("text/current_status", event.target.closest('.kanban-column-body').dataset.status);
            return;
        }
        
        const isDraggedCardSelected = selectedCards.some(card => card.dni === draggedDni);
        
        if (isDraggedCardSelected) {
            event.dataTransfer.setData("text/mode", "multiple");
            // AQUI ESTÁ EL PRIMER CAMBIO: Mapear a solo los DNI antes de serializar
            event.dataTransfer.setData("text/dnis", JSON.stringify(selectedCards.map(c => c.dni)));
            
            const dragImage = document.createElement('div');
            dragImage.className = 'bg-blue-600 text-white p-2 rounded-lg shadow-xl font-bold';
            dragImage.textContent = `Moviendo ${selectedCards.length} candidatos`;
            document.body.appendChild(dragImage);
            event.dataTransfer.setDragImage(dragImage, 10, 10);
            setTimeout(() => document.body.removeChild(dragImage), 0);
            
        } else {
            clearSelection();
            event.dataTransfer.setData("text/mode", "individual");
            event.dataTransfer.setData("text/dni", draggedDni);
            event.dataTransfer.setData("text/current_status", event.target.closest('.kanban-column-body').dataset.status);
        }
    }

    function drop(event) {
        event.preventDefault();
        
        let dropTarget = event.target.closest('.kanban-column-body');
        if (!dropTarget) return;

        const targetColumnId = dropTarget.id;
        const newStatus = STATUS_MAP[targetColumnId];
        const mode = event.dataTransfer.getData("text/mode");
        
        if (mode === "multiple") {
            const dnisJson = event.dataTransfer.getData("text/dnis");
            const dnisArray = JSON.parse(dnisJson);
            
            if (dnisArray.length > 0) {
                // Para el modo masivo, tomamos el estado actual de la primera tarjeta seleccionada
                const currentStatus = document.querySelector(`[data-dni="${dnisArray[0]}"]`).closest('.kanban-column-body').dataset.status;
                handleMultipleDrop(dnisArray, currentStatus, newStatus);
            }
            
        } else {
            const dni = event.dataTransfer.getData("text/dni");
            const currentStatus = event.dataTransfer.getData("text/current_status");
            
            if (currentStatus === newStatus) {
                return;
            }
            
            handleIndividualDrop(dni, currentStatus, newStatus);
        }
        
        clearSelection();
    }
    
    function handleIndividualDrop(dni, currentStatus, newStatus) {
        const card = document.querySelector(`[data-dni="${dni}"]`);
        if (!card) return;

        if (currentStatus === 'REGISTRADO' && newStatus === 'CONVOCADO') {
            const nombreCompleto = card.querySelector('h4').textContent.trim();
            const nombre = nombreCompleto.split('(')[0].trim();
            openInitProcessModal(dni, nombre); 
            return;
        }

        if (currentStatus === 'CAPACITACION_TEORICA' && newStatus === 'CAPACITACION_PRACTICA') {
            const nombreCompleto = card.querySelector('h4').textContent.trim();
            const nombre = nombreCompleto.split('(')[0].trim();
            const procesoId = card.dataset.procesoId;
            if (!procesoId || procesoId === 'None' || isNaN(parseInt(procesoId))) {
                 alert('Error: El candidato no tiene un proceso activo válido. Revise la columna de CONVOCADO.');
                 return;
            }
            openAssignSupervisorIndividualModal(procesoId, nombre);
            return;
        }
        
        confirmIndividualUpdate(dni, newStatus);
    }
    
    function handleMultipleDrop(dnisArray, currentStatus, newStatus) {
        const count = dnisArray.length;
        if (count === 0) return;
        
        // Bloquear transiciones hacia sí mismo
        if (currentStatus === newStatus) {
            alert('Las tarjetas seleccionadas ya se encuentran en ese estado.');
            return;
        }

        if (currentStatus === 'REGISTRADO' && newStatus === 'CONVOCADO') {
            openMassConvocatoriaModal(dnisArray);
            return;
        }

        if (currentStatus === 'CAPACITACION_TEORICA' && newStatus === 'CAPACITACION_PRACTICA') {
            openMassAssignSupervisorModal(dnisArray);
            return;
        }
        
        let confirmMessage = `¿Mover a **${count}** candidatos de **${currentStatus}** a **${newStatus}**?`;
        
        if (confirm(confirmMessage)) {
            confirmMassUpdate(dnisArray, newStatus, {});
        }
    }
    
    function triggerMassAction(targetStatus) {
        if (selectedCards.length === 0) {
            alert('Debes seleccionar al menos un candidato para la acción masiva.');
            return;
        }
        
        const dnisArray = selectedCards.map(c => c.dni); 
        
        const firstCardDni = dnisArray[0];
        const firstCardElement = document.querySelector(`[data-dni="${firstCardDni}"]`);
        
        if (!firstCardElement) {
             alert('Error: No se encontró la tarjeta del primer candidato seleccionado.');
             return;
        }
        
        const currentStatus = firstCardElement.closest('.kanban-column-body').dataset.status;
        
        const allInSameStatus = dnisArray.every(dni => {
            const cardElement = document.querySelector(`[data-dni="${dni}"]`);
            return cardElement && cardElement.closest('.kanban-column-body').dataset.status === currentStatus;
        });

        if (!allInSameStatus) {
             alert('Para la acción masiva, todos los candidatos deben estar en la misma columna de origen.');
             return;
        }

        const targetColumnId = `column-${targetStatus}`;
        const newStatus = STATUS_MAP[targetColumnId];

        handleMultipleDrop(dnisArray, currentStatus, newStatus);
        
        clearSelection();
    }
    
    function confirmIndividualUpdate(dni, newStatus) {
        fetch(updateUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `dni=${dni}&new_status=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // SOLUCIÓN CLAVE: Mostrar el mensaje de éxito enviado por Django
                // que ya contiene el estado uniformizado ("Iniciado/Confirmado").
                alert(data.message); 
                window.location.reload(); 
            } else {
                alert('Error en D&D individual: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error de red en D&D individual:', error);
            alert('Error de red al actualizar el estado individual.');
        });
    }
    
    function confirmMassUpdate(dnisArray, newStatus, extraData) {
        const formData = new FormData();
        
        if (dnisArray.length === 0) {
            alert("Error en actualización masiva: DNI list is required.");
            return;
        }
        
        dnisArray.forEach(dni => {
            formData.append('dnis[]', dni); 
        });
        
        formData.append('new_status', newStatus);
        
        for (const key in extraData) {
            formData.append(key, extraData[key]);
        }
        
        fetch(massiveUpdateUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest', 
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // NOTA: El flujo masivo recarga, pero si quisieras mostrar su mensaje: alert(data.message);
                window.location.reload(); 
            } else {
                alert(`Error en actualización masiva: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error en la actualización masiva:', error);
            alert("Ocurrió un error de conexión al servidor al intentar la acción masiva.");
        });
    }

    function clearSelection() {
        selectedCards = [];
        document.querySelectorAll('.kanban-card.selected').forEach(card => card.classList.remove('selected', 'border-4', 'border-blue-500', 'ring-2', 'ring-blue-500'));
        const massBtn = document.getElementById('btn-mass-action');
        if (massBtn) {
            massBtn.classList.add('hidden');
        }
    }

    function openMassConvocatoriaModal(dnisArray) {
        const count = dnisArray.length;
        document.getElementById('mass-convocatoria-count').textContent = count;
        document.getElementById('mass-convocatoria-dnis').value = JSON.stringify(dnisArray); 
        document.getElementById('massConvocatoriaModal').style.display = 'flex';
    }

    function closeMassConvocatoriaModal() {
        document.getElementById('massConvocatoriaModal').style.display = 'none';
        clearSelection();
    }
    
    document.getElementById('massConvocatoriaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const dnis = JSON.parse(document.getElementById('mass-convocatoria-dnis').value);
        const newStatus = e.target.elements.new_status.value;
        const fechaInicio = e.target.elements.fecha_inicio.value;
        
        confirmMassUpdate(dnis, newStatus, { fecha_inicio: fechaInicio });
        closeMassConvocatoriaModal();
    });
    
    function openMassAssignSupervisorModal(dnisArray) {
        const count = dnisArray.length;
        document.getElementById('mass-supervisor-count').textContent = count;
        document.getElementById('mass-supervisor-dnis').value = JSON.stringify(dnisArray); 
        document.getElementById('massAssignSupervisorModal').style.display = 'flex';
    }

    function closeMassAssignSupervisorModal() {
        document.getElementById('massAssignSupervisorModal').style.display = 'none';
        clearSelection();
    }
    
    document.getElementById('massAssignSupervisorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const dnis = JSON.parse(document.getElementById('mass-supervisor-dnis').value);
        const newStatus = e.target.elements.new_status.value;
        const supervisorId = e.target.elements.supervisor_id.value;
        
        confirmMassUpdate(dnis, newStatus, { supervisor_id: supervisorId });
        closeMassAssignSupervisorModal();
    });
    
    function openInitProcessModal(dni, nombre) {
        document.getElementById('init-candidato-dni').textContent = dni;
        document.getElementById('init-candidato-nombre').textContent = nombre;
        
        const form = document.getElementById('initProcessForm');
        const baseAction = form.dataset.baseAction || form.action.replace(dni, 'DNI_PLACEHOLDER');
        form.action = baseAction.replace('DNI_PLACEHOLDER', dni);
        
        document.getElementById('initProcessModal').style.display = 'flex';
    }

    function closeInitProcessModal() {
        document.getElementById('initProcessModal').style.display = 'none';
    }

    function openAssignSupervisorIndividualModal(procesoId, nombre) {
        document.getElementById('assign-proceso-id').value = procesoId;
        document.getElementById('assign-candidato-nombre').textContent = nombre;
        
        const form = document.getElementById('assignSupervisorIndividualForm');
        const baseAction = form.dataset.baseAction || form.action.replace(new RegExp(`/${procesoId}/$`), '/0/');
        form.action = baseAction.replace('/0/', `/${procesoId}/`); 
        
        document.getElementById('assignSupervisorIndividualModal').style.display = 'flex';
    }

    function closeAssignSupervisorIndividualModal() {
        document.getElementById('assignSupervisorIndividualModal').style.display = 'none';
    }
    
    function openUpdateProcessModal(procesoId, nombre, estado, empresa, supervisor, objetivo, actitud) {
        document.getElementById('update-proceso-id').value = procesoId;
        document.getElementById('update-candidato-nombre').textContent = nombre;
        document.getElementById('update-empresa-nombre').textContent = empresa;
        document.getElementById('update-supervisor-nombre').textContent = supervisor;
        
        document.getElementById('id_estado_proceso_update').value = estado;
        
        const form = document.getElementById('updateProcessForm');
        const baseAction = form.dataset.baseAction || form.action.replace(new RegExp(`/${procesoId}/$`), '/0/');
        form.action = baseAction.replace('/0/', `/${procesoId}/`); 
        
        const performanceFields = document.getElementById('performance-fields');
        const updateSelect = document.getElementById('id_estado_proceso_update');

        function togglePerformanceFields() {
             const selectedState = updateSelect.value;
             if (selectedState === 'CONTRATADO' || selectedState === 'NO_APTO') {
                 performanceFields.style.display = 'block';
                 document.getElementById('id_objetivo_ventas_alcanzado').checked = objetivo === 'true';
                 document.getElementById('id_factor_actitud_aplica').checked = actitud === 'true';
             } else {
                 performanceFields.style.display = 'none';
             }
        }
        
        updateSelect.onchange = togglePerformanceFields;
        togglePerformanceFields();
        
        document.getElementById('updateProcessModal').style.display = 'flex';
    }

    function closeUpdateProcessModal() {
        document.getElementById('updateProcessModal').style.display = 'none';
    }
    
    function openHistoryModal(dni, nombre) {
        document.getElementById('history-candidato-dni').textContent = dni;
        document.getElementById('history-candidato-nombre').textContent = nombre;
        const historyContent = document.getElementById('history-content');
        historyContent.innerHTML = '<p class="text-center text-gray-500">Cargando historial...</p>';

        const url = historyApiUrl.replace('DNI_PLACEHOLDER', dni);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                let html = '';
                if (data.procesos && data.procesos.length > 0) {
                    data.procesos.forEach((p, index) => {
                        html += `
                            <div class="border p-3 rounded-lg shadow-sm ${index === 0 ? 'border-red-500 bg-red-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="text-sm font-bold text-gray-800">${index === 0 ? 'ACTIVO (ÚLTIMO)' : 'Proceso Anterior'}</p>
                                <p class="text-xs text-gray-600 mt-1">
                                    <span class="font-semibold">Convocatoria:</span> ${p.fecha_inicio} (${p.empresa_proceso.nombre} - ${p.sede_proceso.nombre})
                                </p>
                                <p class="text-xs text-gray-600">
                                    <span class="font-semibold">Supervisor:</span> ${p.supervisor_nombre || 'Pendiente de Asignar'}
                                </p>
                                <p class="text-xs text-gray-600">
                                    <span class="font-semibold">Resultado Final:</span> <span class="font-bold text-red-600">${p.estado}</span>
                                </p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p class="text-center text-gray-500">No se encontró historial de procesos para este candidato.</p>';
                }
                historyContent.innerHTML = html;
            })
            .catch(error => {
                historyContent.innerHTML = `<p class="text-center text-red-500">Error al cargar el historial: ${error.message}</p>`;
                console.error('Error al cargar historial:', error);
            });

        document.getElementById('historyModal').style.display = 'flex';
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    function openAsistenciaModal(dni, procesoId) {
        const modalElement = document.getElementById('asistenciaModal');
        if (modalElement) {
            document.getElementById('asistencia-proceso-id-input').value = procesoId;
            document.getElementById('asistencia-candidato-dni-display').textContent = dni;
            
            modalElement.style.display = 'flex'; 
        } else {
            console.error("Error: El modal con ID 'asistenciaModal' no fue encontrado en el DOM.");
        }
    }

    function closeAsistenciaModal() {
        document.getElementById('asistenciaModal').style.display = 'none';
    }

    function openConvocarModal(dni, nombre) {
        openInitProcessModal(dni, nombre);
    }
    
    function copyLink(buttonElement, linkToCopy) {
        
        // 1. Copiar el enlace al portapapeles
        // (Usamos la API moderna Clipboard si está disponible, si no, el método antiguo)
        if (navigator.clipboard) {
            navigator.clipboard.writeText(linkToCopy).then(() => {
                // Éxito en la copia
                showCopyFeedback(buttonElement);
            }).catch(err => {
                console.error('Error al copiar (API Clipboard):', err);
            });
        } else {
            // Método de respaldo (requiere crear y usar un textarea temporal)
            const tempInput = document.createElement('textarea');
            tempInput.value = linkToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            showCopyFeedback(buttonElement);
        }
    }

    // Función para mostrar la retroalimentación visual
    function showCopyFeedback(buttonElement) {
        const messageSpan = buttonElement.querySelector('#copy-message');
        
        // 1. Mostrar el mensaje
        messageSpan.classList.remove('opacity-0');
        messageSpan.classList.add('opacity-100');

        // 2. Revertir el estado después de 2 segundos
        setTimeout(() => {
            messageSpan.classList.remove('opacity-100');
            messageSpan.classList.add('opacity-0');
        }, 2000);
    }

    const messageContainer = document.getElementById('message-container');
        if (messageContainer) {
            // Oculta después de 2 segundos (2000ms)
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 2000); 
        }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.kanban-column-body').forEach(column => {
            column.addEventListener('dragover', allowDrop);
            column.addEventListener('drop', drop);
            column.id = `column-${column.dataset.status}`;
        });
        
        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', drag);
        });
        
        const messageAlerts = document.querySelectorAll('.message-alert');
        messageAlerts.forEach(alert => {
            setTimeout(() => {
                alert.style.opacity = '0'; 
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 500); 
            }, 5000); 
        });

        const dateButtons = document.querySelectorAll('.filter-date-btn');

        dateButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const selectedDate = event.currentTarget.dataset.date;
                const currentUrl = new URL(window.location.href);
                
                currentUrl.searchParams.set('fecha_inicio', selectedDate);
                
                window.location.href = currentUrl.toString();
            });
        });

        const allDatesButton = document.getElementById('all-dates-filter-btn');
        if (allDatesButton) {
             allDatesButton.addEventListener('click', (event) => {
                 event.preventDefault(); 
                 const currentUrl = new URL(window.location.href);
                 currentUrl.searchParams.delete('fecha_inicio');
                 window.location.href = currentUrl.toString();
             });
        }
        
        const dniSearchInput = document.getElementById('dni-search');
        
        dniSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                
                const searchValue = dniSearchInput.value.trim();
                const currentUrl = new URL(window.location.href);
                
                const isExactDNI = /^\d{8,10}$/.test(searchValue); 

                if (isExactDNI) {
                    fetch(`${API_ASISTENCIA_CHECK_URL}?dni=${searchValue}`)
                        .then(response => response.json())
                        .then(data => {
                            
                            if (data.candidato_encontrado && !data.asistencia_registrada && data.proceso_id) {
                                
                                openAsistenciaModal(data.dni, data.proceso_id);
                                
                                const currentUrl = new URL(window.location.href);
                                currentUrl.searchParams.set('search', searchValue);
                                window.history.pushState({}, '', currentUrl);

                            } else {
                                currentUrl.searchParams.set('search', searchValue);
                                window.location.href = currentUrl.toString();
                            }
                        })
                        .catch(error => {
                            console.error('Error de red o API:', error);
                            currentUrl.searchParams.set('search', searchValue);
                            window.location.href = currentUrl.toString();
                        });
                } else {
                    if (searchValue) {
                        currentUrl.searchParams.set('search', searchValue);
                    } else {
                        currentUrl.searchParams.delete('search');
                    }
                    window.location.href = currentUrl.toString();
                }
            }
        });
         function openMassActionMenu() {
          document.getElementById('massActionMenu').classList.remove('hidden');
         }
        
         function closeMassActionMenu() {
             document.getElementById('massActionMenu').classList.add('hidden');
         }
        
         document.addEventListener('click', function(event) {
             const menu = document.getElementById('massActionMenu');
             const button = document.getElementById('btn-mass-action');
             if (menu && button && !menu.contains(event.target) && !button.contains(event.target) && !menu.classList.contains('hidden')) {
                 closeMassActionMenu();
             }
         });

        const toggleHeader = document.getElementById('toggle-header');
        const collapsibleContent = document.getElementById('collapsible-content');
        const toggleIcon = document.getElementById('toggle-icon');
        
        // --- 1. Funcionalidad de Plegar/Desplegar (Acordeón) ---
        if (toggleHeader && collapsibleContent && toggleIcon) {
            // Aseguramos que el contenido esté VISIBLE al cargar por defecto, 
            // a menos que desees que inicie oculto (en ese caso, añade 'hidden' al div del contenido y quita 'rotate-180' al icono).
            // Lo dejaremos visible inicialmente para buena UX.
            
            toggleHeader.addEventListener('click', function() {
                // Alternar la visibilidad del contenido
                collapsibleContent.classList.toggle('hidden'); 
                
                // Rotar el ícono de flecha (90 grados para cerrar, 180 para abrir)
                toggleIcon.classList.toggle('rotate-180');
            });
        }


        // --- 2. Funcionalidad del Dropdown de Desactivación ---
        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');

        if (menuButton && dropdownMenu) {
            
            // Función para alternar la visibilidad del menú
            function toggleDropdown() {
                const isHidden = dropdownMenu.classList.contains('hidden');
                if (isHidden) {
                    dropdownMenu.classList.remove('hidden');
                    menuButton.setAttribute('aria-expanded', 'true');
                } else {
                    dropdownMenu.classList.add('hidden');
                    menuButton.setAttribute('aria-expanded', 'false');
                }
            }

            // Abrir/Cerrar al hacer clic en el botón de menú
            menuButton.addEventListener('click', function(event) {
                event.stopPropagation(); // Evita que el clic cierre inmediatamente el menú o afecte otros elementos
                toggleDropdown();
            });

            // Cerrar al hacer clic fuera del menú o presionar ESC
            document.addEventListener('click', function (event) {
                if (!menuButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    if (!dropdownMenu.classList.contains('hidden')) {
                        dropdownMenu.classList.add('hidden');
                        menuButton.setAttribute('aria-expanded', 'false');
                    }
                }
            });
            
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && !dropdownMenu.classList.contains('hidden')) {
                    dropdownMenu.classList.add('hidden');
                    menuButton.setAttribute('aria-expanded', 'false');
                }
            });
        }
    });
</script>
{% endblock extra_js %}