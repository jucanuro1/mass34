{% extends "base.html" %}

{% block title %}+ 34{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <header class="mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Panel <span class="text-red-600">Administración</span></h1>

        <div class="flex items-center space-x-4">
            <div class="relative w-80">
                <input type="text" id="dni-search" placeholder="Buscar por DNI o Nombre..." class="w-full text-xs pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-red-500 focus:border-red-500">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            
            <a href="{% url 'registro_candidato' %}" class="flex text-xs items-center bg-red-600 text-white px-5 py-2.5 rounded-full shadow-lg font-semibold hover:bg-red-700 transition duration-150 transform hover:scale-105">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Nuevo Candidato
            </a>
        </div>
    </header>

    {% if messages %}
        <div class="mt-4" id="message-container">
            {% for message in messages %}
                <div class="p-3 mb-2 rounded-lg text-sm flex justify-between items-center transition-opacity duration-500 message-alert {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}" role="alert">
                    {{ message }}
                    
                    <button type="button" class="ml-4 -mr-1 p-1 rounded-full hover:opacity-75 close-button" 
                        aria-label="Close" 
                        onclick="this.closest('.message-alert').style.display='none';"
                        {% if message.tags == 'success' %}
                            style="color: #065f46;"
                        {% elif message.tags == 'error' %}
                            style="color: #991b1b;"
                        {% else %}
                            style="color: #a16207;"
                        {% endif %}
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="mb-8 p-6 bg-white rounded-2xl shadow-xl transition-all duration-300 border-t-4 border-cyan-950/70">
        <h2 class="text-lg font-extrabold text-cyan-900 mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            Filtro de Convocatoria
        </h2>
        
        <div class="flex flex-wrap gap-x-2 gap-y-3 pt-2" id="convocatoria-filters">
            
            {# Botón de TODAS las Fechas #}
            {% url 'kanban_dashboard' as all_url %}
            <a href="{{ all_url }}"
                class="flex items-center px-4 py-2 text-sm font-bold rounded-full transition duration-200 shadow-md transform hover:scale-[1.03]
                {% if not active_date %} bg-red-600 text-white shadow-red-300/60 {% else %} bg-gray-100 text-gray-700 hover:bg-gray-200 {% endif %}">
                
                Todas las Fechas 
                <span class="ml-2 px-2 py-0.5 text-xs font-extrabold rounded-full 
                    {% if not active_date %} bg-white/20 text-white {% else %} bg-gray-200 text-red-600 {% endif %}">
                    {{ total_candidatos }}
                </span>
            </a>

            {# Loops de Fechas (Convertido a <a> para navegación directa) #}
            {% for date_obj in convocatoria_dates %}
                {% with date_str=date_obj.fecha_inicio|date:"Y-m-d" %}
                    {# Construcción dinámica de la URL: /kanban/?fecha_inicio=YYYY-MM-DD #}
                    {% url 'kanban_dashboard' as base_url %}
                    {% with filter_url=base_url|add:"?fecha_inicio="|add:date_str %}
                        
                        <a href="{{ filter_url }}" 
                            class="px-4 py-2 text-xs font-medium rounded-full transition duration-150 hover:bg-red-50 hover:text-red-700
                            {% if active_date|date:"Y-m-d" == date_str %} bg-red-500 text-white shadow-md transform hover:scale-[1.03] {% else %} bg-gray-100 text-gray-700 {% endif %}">
                            
                            {{ date_obj.fecha_inicio|date:"d/M/y" }} 
                            <span class="ml-1 px-1.5 py-0.5 text-xs font-bold rounded-full 
                                {% if active_date|date:"Y-m-d" == date_str %} bg-white/20 text-white {% else %} bg-gray-300 text-gray-800 {% endif %}">
                                {{ date_obj.count }}
                            </span>
                        </a>
                    {% endwith %}
                {% endwith %}
            {% endfor %} 
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
        {% include "kanban_column.html" with status_key='REGISTRADO' title='1. Registrado' color='border-red-500' data=kanban_data.REGISTRADO %}
        {% include "kanban_column.html" with status_key='CONVOCADO' title='2. Convocado' color='border-indigo-500' data=kanban_data.CONVOCADO %}
        {% include "kanban_column.html" with status_key='CAPACITACION_TEORICA' title='3. Teoría' color='border-yellow-500' data=kanban_data.CAPACITACION_TEORICA %}
        {% include "kanban_column.html" with status_key='CAPACITACION_PRACTICA' title='4. Práctica' color='border-orange-500' data=kanban_data.CAPACITACION_PRACTICA %}
        {% include "kanban_column.html" with status_key='CONTRATADO' title='5. Contratado' color='border-green-500' data=kanban_data.CONTRATADO %}
    </div>
</div>

{# Modals individuales existentes (solo se mantienen, la lógica D&D llama a las funciones) #}

<div id="initProcessModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold text-red-600 mb-4">Iniciar Nuevo Proceso / Convocatoria (Individual)</h3>
        <p class="text-gray-700 mb-4">Moviendo a: <span id="init-candidato-nombre" class="font-semibold"></span> (<span id="init-candidato-dni"></span>)</p>

        <form method="post" action="{% url 'iniciar_proceso' dni='DNI_PLACEHOLDER' %}" id="initProcessForm">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="id_fecha_inicio" class="block text-sm font-medium text-gray-700">Fecha de Inicio (Convocatoria):</label>
                <input type="date" name="fecha_inicio" id="id_fecha_inicio" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-red-500 focus:border-red-500" required>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeInitProcessModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150">Guardar y Convocado</button>
            </div>
        </form>
    </div>
</div>

<div id="assignSupervisorIndividualModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold text-orange-600 mb-4">Asignar Supervisor para Práctica (Individual)</h3>
        <p class="text-gray-700 mb-4">Moviendo a: <span id="assign-candidato-nombre" class="font-semibold"></span></p>

        <form method="post" action="{% url 'asignar_supervisor_individual' proceso_id=0 %}" id="assignSupervisorIndividualForm">
            {% csrf_token %}
            <input type="hidden" name="proceso_id" id="assign-proceso-id">
            
            <div class="mb-4">
                <label for="id_supervisor_id_individual" class="block text-sm font-medium text-gray-700">Supervisor/Formador para Práctica:</label>
                <select name="supervisor_id" id="id_supervisor_id_individual" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    <option value="">Seleccione Supervisor</option>
                    {% for supervisor in supervisores %}
                        <option value="{{ supervisor.pk }}">{{ supervisor.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeAssignSupervisorIndividualModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition duration-150">Asignar y Mover a Práctica</button>
            </div>
        </form>
    </div>
</div>

{# ------------------------------------------------------------------------------------------------ #}
{# NUEVOS MODALES PARA ACCIÓN MASIVA #}
{# ------------------------------------------------------------------------------------------------ #}

<div id="massConvocatoriaModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold text-red-600 mb-4">Asignación Masiva: Convocatoria</h3>
        <p class="text-gray-700 mb-4">Se moverán <span id="mass-convocatoria-count" class="font-semibold text-red-700">0</span> candidatos de **REGISTRADO** a **CONVOCADO**.</p>
        
        <form id="massConvocatoriaForm">
            {% csrf_token %}
            <input type="hidden" name="new_status" value="CONVOCADO">
            <input type="hidden" name="dnis" id="mass-convocatoria-dnis">
            
            <div class="mb-4">
                <label for="id_mass_fecha_inicio" class="block text-sm font-medium text-gray-700">Fecha de Inicio (Convocatoria) para el Bloque:</label>
                <input type="date" name="fecha_inicio" id="id_mass_fecha_inicio" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-red-500 focus:border-red-500" required>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeMassConvocatoriaModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150">Aplicar a Bloque y Mover</button>
            </div>
        </form>
    </div>
</div>

<div id="massAssignSupervisorModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold text-orange-600 mb-4">Asignación Masiva: Supervisor para Práctica</h3>
        <p class="text-gray-700 mb-4">Se moverán <span id="mass-supervisor-count" class="font-semibold text-orange-700">0</span> candidatos de **TEORÍA** a **PRÁCTICA**.</p>

        <form id="massAssignSupervisorForm">
            {% csrf_token %}
            <input type="hidden" name="new_status" value="CAPACITACION_PRACTICA">
            <input type="hidden" name="dnis" id="mass-supervisor-dnis">
            
            <div class="mb-4">
                <label for="id_mass_supervisor_id" class="block text-sm font-medium text-gray-700">Supervisor/Formador para el Bloque de Práctica:</label>
                <select name="supervisor_id" id="id_mass_supervisor_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    <option value="">Seleccione Supervisor</option>
                    {% for supervisor in supervisores %}
                        <option value="{{ supervisor.pk }}">{{ supervisor.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeMassAssignSupervisorModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition duration-150">Asignar a Bloque y Mover</button>
            </div>
        </form>
    </div>
</div>

{# Modals existentes (se mantienen) #}
<div id="updateProcessModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold text-yellow-600 mb-4">Actualizar Proceso y Resultado Final</h3>
        <p class="text-gray-700 mb-4">Candidato: <span id="update-candidato-nombre" class="font-semibold"></span></p>
        <p class="text-gray-700 mb-4">Proceso Activo: <span id="update-empresa-nombre" class="font-semibold"></span> | Supervisor: <span id="update-supervisor-nombre" class="font-semibold"></span></p>

        <form method="post" action="{% url 'actualizar_proceso' proceso_id=0 %}" id="updateProcessForm">
            {% csrf_token %}
            <input type="hidden" name="proceso_id" id="update-proceso-id">

            <div class="mb-4">
                <label for="id_estado_proceso_update" class="block text-sm font-medium text-gray-700">Nuevo Estado del Proceso:</label>
                <select name="estado_proceso" id="id_estado_proceso_update" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    <option value="">Seleccione Estado</option>
                    {% for key, value in Proceso.ESTADOS_PROCESO %}
                        <option value="{{ key }}">{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="border p-4 rounded-md space-y-3" id="performance-fields" style="display:none;">
                <p class="font-semibold text-sm">Campos de Resultado (Solo para Contratado/No Apto):</p>
                <div>
                    <input type="checkbox" name="objetivo_ventas_alcanzado" id="id_objetivo_ventas_alcanzado">
                    <label for="id_objetivo_ventas_alcanzado" class="text-sm font-medium text-gray-700 ml-2">¿Alcanzó Objetivo/KPIs de ventas?</label>
                </div>
                <div>
                    <input type="checkbox" name="factor_actitud_aplica" id="id_factor_actitud_aplica">
                    <label for="id_factor_actitud_aplica" class="text-sm font-medium text-gray-700 ml-2">¿Aplica Contratación por Factor Actitud?</label>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeUpdateProcessModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-150">Finalizar/Actualizar</button>
            </div>
        </form>
    </div>
</div>

<div id="historyModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Historial de Convocatorias y Procesos</h3>
        <p class="text-gray-700 mb-4">Candidato: <span id="history-candidato-nombre" class="font-semibold"></span> (<span id="history-candidato-dni" class="font-semibold"></span>)</p>

        <div id="history-content" class="max-h-96 overflow-y-auto space-y-4">
            <p class="text-center text-gray-500">Cargando historial...</p>
        </div>

        <div class="flex justify-end mt-6">
            <button type="button" onclick="closeHistoryModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">Cerrar</button>
        </div>
    </div>
</div>

<div id="asistenciaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 justify-center items-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
        <h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">Registro Rápido de Asistencia</h3>
        
        <form id="asistenciaRapidaForm" method="POST" action="{% url 'registrar_asistencia_rapida' %}">
            {% csrf_token %}
            
            <input type="hidden" name="proceso_id" id="asistencia-proceso-id-input" value="">

            <p class="text-gray-700 mb-4">
                ¿Registrar la asistencia de <span id="asistencia-candidato-dni-display" class="font-semibold text-gray-900"></span> para hoy?
            </p>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeAsistenciaModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                    Marcar Asistencia
                </button>
            </div>
        </form>
    </div>
</div>
<button 
    id="btn-mass-action" 
    class="hidden fixed bottom-5 right-5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition duration-300"
    onclick="openMassActionMenu()">
    Acción Masiva <span id="selected-count" class="ml-1 px-2 py-1 bg-white text-blue-600 rounded-full text-xs font-black">0</span>
</button>

<div id="massActionMenu" class="hidden fixed bottom-20 right-5 p-4 bg-white border rounded shadow-lg z-50">
    <p class="font-bold mb-2">Mover Seleccionados a:</p>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CONVOCADO'); closeMassActionMenu();">CONVOCADO</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CAPACITACION_TEORICA'); closeMassActionMenu();">CAP. TEÓRICA</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CAPACITACION_PRACTICA'); closeMassActionMenu();">CAP. PRÁCTICA</button>
    <button class="w-full text-left py-1 px-2 hover:bg-gray-100" onclick="triggerMassAction('CONTRATADO'); closeMassActionMenu();">CONTRATADO</button>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    const updateUrl = "{% url 'update_candidato_status' %}";
    const massiveUpdateUrl = "{% url 'update_candidato_status_multiple' %}";
    const historyApiUrl = "";
    const API_ASISTENCIA_CHECK_URL = "{% url 'api_asistencia_check' %}";
    const csrfToken = "{{ csrf_token }}";

    const STATUS_MAP = {
        'column-REGISTRADO': 'REGISTRADO',
        'column-CONVOCADO': 'CONVOCADO',
        'column-CAPACITACION_TEORICA': 'CAPACITACION_TEORICA',
        'column-CAPACITACION_PRACTICA': 'CAPACITACION_PRACTICA',
        'column-CONTRATADO': 'CONTRATADO'
    };
    
    let selectedCards = [];

    function toggleCardSelection(cardElement) {
        const dni = cardElement.getAttribute('data-dni');
        const procesoId = cardElement.getAttribute('data-proceso-id');

        if (cardElement.classList.contains('dragging')) return;

        if (cardElement.classList.contains('selected')) {
            cardElement.classList.remove('selected', 'border-4', 'border-blue-500', 'ring-2', 'ring-blue-500'); 
            selectedCards = selectedCards.filter(card => card.dni !== dni);
        } else {
            cardElement.classList.add('selected', 'border-4', 'border-blue-500', 'ring-2', 'ring-blue-500');
            selectedCards.push({ dni: dni, proceso_id: procesoId });
        }
        
        const massBtn = document.getElementById('btn-mass-action');
        const selectedCountSpan = document.getElementById('selected-count');
        
        if (selectedCards.length > 0) {
            massBtn.classList.remove('hidden');
            selectedCountSpan.textContent = selectedCards.length;
        } else {
            massBtn.classList.add('hidden');
        }
        
        console.log(`Tarjetas seleccionadas: ${selectedCards.length}`, selectedCards);
    }
    
    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        const draggedDni = event.target.dataset.dni;
        
        if (selectedCards.length === 0) {
            event.dataTransfer.setData("text/mode", "individual");
            event.dataTransfer.setData("text/dni", draggedDni);
            event.dataTransfer.setData("text/current_status", event.target.closest('.kanban-column-body').dataset.status);
            return;
        }
        
        const isDraggedCardSelected = selectedCards.some(card => card.dni === draggedDni);
        
        if (isDraggedCardSelected) {
            event.dataTransfer.setData("text/mode", "multiple");
            // AQUI ESTÁ EL PRIMER CAMBIO: Mapear a solo los DNI antes de serializar
            event.dataTransfer.setData("text/dnis", JSON.stringify(selectedCards.map(c => c.dni)));
            
            const dragImage = document.createElement('div');
            dragImage.className = 'bg-blue-600 text-white p-2 rounded-lg shadow-xl font-bold';
            dragImage.textContent = `Moviendo ${selectedCards.length} candidatos`;
            document.body.appendChild(dragImage);
            event.dataTransfer.setDragImage(dragImage, 10, 10);
            setTimeout(() => document.body.removeChild(dragImage), 0);
            
        } else {
            clearSelection();
            event.dataTransfer.setData("text/mode", "individual");
            event.dataTransfer.setData("text/dni", draggedDni);
            event.dataTransfer.setData("text/current_status", event.target.closest('.kanban-column-body').dataset.status);
        }
    }

    function drop(event) {
        event.preventDefault();
        
        let dropTarget = event.target.closest('.kanban-column-body');
        if (!dropTarget) return;

        const targetColumnId = dropTarget.id;
        const newStatus = STATUS_MAP[targetColumnId];
        const mode = event.dataTransfer.getData("text/mode");
        
        if (mode === "multiple") {
            const dnisJson = event.dataTransfer.getData("text/dnis");
            const dnisArray = JSON.parse(dnisJson);
            
            if (dnisArray.length > 0) {
                // Para el modo masivo, tomamos el estado actual de la primera tarjeta seleccionada
                const currentStatus = document.querySelector(`[data-dni="${dnisArray[0]}"]`).closest('.kanban-column-body').dataset.status;
                handleMultipleDrop(dnisArray, currentStatus, newStatus);
            }
            
        } else {
            const dni = event.dataTransfer.getData("text/dni");
            const currentStatus = event.dataTransfer.getData("text/current_status");
            
            if (currentStatus === newStatus) {
                return;
            }
            
            handleIndividualDrop(dni, currentStatus, newStatus);
        }
        
        clearSelection();
    }
    
    function handleIndividualDrop(dni, currentStatus, newStatus) {
        const card = document.querySelector(`[data-dni="${dni}"]`);
        if (!card) return;

        if (currentStatus === 'REGISTRADO' && newStatus === 'CONVOCADO') {
            const nombreCompleto = card.querySelector('h4').textContent.trim();
            const nombre = nombreCompleto.split('(')[0].trim();
            openInitProcessModal(dni, nombre); 
            return;
        }

        if (currentStatus === 'CAPACITACION_TEORICA' && newStatus === 'CAPACITACION_PRACTICA') {
            const nombreCompleto = card.querySelector('h4').textContent.trim();
            const nombre = nombreCompleto.split('(')[0].trim();
            const procesoId = card.dataset.procesoId;
            if (!procesoId || procesoId === 'None' || isNaN(parseInt(procesoId))) {
                 alert('Error: El candidato no tiene un proceso activo válido. Revise la columna de CONVOCADO.');
                 return;
            }
            openAssignSupervisorIndividualModal(procesoId, nombre);
            return;
        }
        
        confirmIndividualUpdate(dni, newStatus);
    }
    
    function handleMultipleDrop(dnisArray, currentStatus, newStatus) {
        const count = dnisArray.length;
        if (count === 0) return;
        
        // Bloquear transiciones hacia sí mismo
        if (currentStatus === newStatus) {
            alert('Las tarjetas seleccionadas ya se encuentran en ese estado.');
            return;
        }

        if (currentStatus === 'REGISTRADO' && newStatus === 'CONVOCADO') {
            openMassConvocatoriaModal(dnisArray);
            return;
        }

        if (currentStatus === 'CAPACITACION_TEORICA' && newStatus === 'CAPACITACION_PRACTICA') {
            openMassAssignSupervisorModal(dnisArray);
            return;
        }
        
        let confirmMessage = `¿Mover a **${count}** candidatos de **${currentStatus}** a **${newStatus}**?`;
        
        if (confirm(confirmMessage)) {
            confirmMassUpdate(dnisArray, newStatus, {});
        }
    }
    
    function triggerMassAction(targetStatus) {
        if (selectedCards.length === 0) {
            alert('Debes seleccionar al menos un candidato para la acción masiva.');
            return;
        }
        
        const dnisArray = selectedCards.map(c => c.dni); 
        
        const firstCardDni = dnisArray[0];
        const firstCardElement = document.querySelector(`[data-dni="${firstCardDni}"]`);
        
        if (!firstCardElement) {
             alert('Error: No se encontró la tarjeta del primer candidato seleccionado.');
             return;
        }
        
        const currentStatus = firstCardElement.closest('.kanban-column-body').dataset.status;
        
        const allInSameStatus = dnisArray.every(dni => {
            const cardElement = document.querySelector(`[data-dni="${dni}"]`);
            return cardElement && cardElement.closest('.kanban-column-body').dataset.status === currentStatus;
        });

        if (!allInSameStatus) {
             alert('Para la acción masiva, todos los candidatos deben estar en la misma columna de origen.');
             return;
        }

        const targetColumnId = `column-${targetStatus}`;
        const newStatus = STATUS_MAP[targetColumnId];

        handleMultipleDrop(dnisArray, currentStatus, newStatus);
        
        clearSelection();
    }
    
    function confirmIndividualUpdate(dni, newStatus) {
        fetch(updateUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `dni=${dni}&new_status=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // SOLUCIÓN CLAVE: Mostrar el mensaje de éxito enviado por Django
                // que ya contiene el estado uniformizado ("Iniciado/Confirmado").
                alert(data.message); 
                window.location.reload(); 
            } else {
                alert('Error en D&D individual: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error de red en D&D individual:', error);
            alert('Error de red al actualizar el estado individual.');
        });
    }
    
    function confirmMassUpdate(dnisArray, newStatus, extraData) {
        const formData = new FormData();
        
        if (dnisArray.length === 0) {
            alert("Error en actualización masiva: DNI list is required.");
            return;
        }
        
        dnisArray.forEach(dni => {
            formData.append('dnis[]', dni); 
        });
        
        formData.append('new_status', newStatus);
        
        for (const key in extraData) {
            formData.append(key, extraData[key]);
        }
        
        fetch(massiveUpdateUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest', 
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // NOTA: El flujo masivo recarga, pero si quisieras mostrar su mensaje: alert(data.message);
                window.location.reload(); 
            } else {
                alert(`Error en actualización masiva: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error en la actualización masiva:', error);
            alert("Ocurrió un error de conexión al servidor al intentar la acción masiva.");
        });
    }

    function clearSelection() {
        selectedCards = [];
        document.querySelectorAll('.kanban-card.selected').forEach(card => card.classList.remove('selected', 'border-4', 'border-blue-500', 'ring-2', 'ring-blue-500'));
        const massBtn = document.getElementById('btn-mass-action');
        if (massBtn) {
            massBtn.classList.add('hidden');
        }
    }

    function openMassConvocatoriaModal(dnisArray) {
        const count = dnisArray.length;
        document.getElementById('mass-convocatoria-count').textContent = count;
        document.getElementById('mass-convocatoria-dnis').value = JSON.stringify(dnisArray); 
        document.getElementById('massConvocatoriaModal').style.display = 'flex';
    }

    function closeMassConvocatoriaModal() {
        document.getElementById('massConvocatoriaModal').style.display = 'none';
        clearSelection();
    }
    
    document.getElementById('massConvocatoriaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const dnis = JSON.parse(document.getElementById('mass-convocatoria-dnis').value);
        const newStatus = e.target.elements.new_status.value;
        const fechaInicio = e.target.elements.fecha_inicio.value;
        
        confirmMassUpdate(dnis, newStatus, { fecha_inicio: fechaInicio });
        closeMassConvocatoriaModal();
    });
    
    function openMassAssignSupervisorModal(dnisArray) {
        const count = dnisArray.length;
        document.getElementById('mass-supervisor-count').textContent = count;
        document.getElementById('mass-supervisor-dnis').value = JSON.stringify(dnisArray); 
        document.getElementById('massAssignSupervisorModal').style.display = 'flex';
    }

    function closeMassAssignSupervisorModal() {
        document.getElementById('massAssignSupervisorModal').style.display = 'none';
        clearSelection();
    }
    
    document.getElementById('massAssignSupervisorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const dnis = JSON.parse(document.getElementById('mass-supervisor-dnis').value);
        const newStatus = e.target.elements.new_status.value;
        const supervisorId = e.target.elements.supervisor_id.value;
        
        confirmMassUpdate(dnis, newStatus, { supervisor_id: supervisorId });
        closeMassAssignSupervisorModal();
    });
    
    function openInitProcessModal(dni, nombre) {
        document.getElementById('init-candidato-dni').textContent = dni;
        document.getElementById('init-candidato-nombre').textContent = nombre;
        
        const form = document.getElementById('initProcessForm');
        const baseAction = form.dataset.baseAction || form.action.replace(dni, 'DNI_PLACEHOLDER');
        form.action = baseAction.replace('DNI_PLACEHOLDER', dni);
        
        document.getElementById('initProcessModal').style.display = 'flex';
    }

    function closeInitProcessModal() {
        document.getElementById('initProcessModal').style.display = 'none';
    }

    function openAssignSupervisorIndividualModal(procesoId, nombre) {
        document.getElementById('assign-proceso-id').value = procesoId;
        document.getElementById('assign-candidato-nombre').textContent = nombre;
        
        const form = document.getElementById('assignSupervisorIndividualForm');
        const baseAction = form.dataset.baseAction || form.action.replace(new RegExp(`/${procesoId}/$`), '/0/');
        form.action = baseAction.replace('/0/', `/${procesoId}/`); 
        
        document.getElementById('assignSupervisorIndividualModal').style.display = 'flex';
    }

    function closeAssignSupervisorIndividualModal() {
        document.getElementById('assignSupervisorIndividualModal').style.display = 'none';
    }
    
    function openUpdateProcessModal(procesoId, nombre, estado, empresa, supervisor, objetivo, actitud) {
        document.getElementById('update-proceso-id').value = procesoId;
        document.getElementById('update-candidato-nombre').textContent = nombre;
        document.getElementById('update-empresa-nombre').textContent = empresa;
        document.getElementById('update-supervisor-nombre').textContent = supervisor;
        
        document.getElementById('id_estado_proceso_update').value = estado;
        
        const form = document.getElementById('updateProcessForm');
        const baseAction = form.dataset.baseAction || form.action.replace(new RegExp(`/${procesoId}/$`), '/0/');
        form.action = baseAction.replace('/0/', `/${procesoId}/`); 
        
        const performanceFields = document.getElementById('performance-fields');
        const updateSelect = document.getElementById('id_estado_proceso_update');

        function togglePerformanceFields() {
             const selectedState = updateSelect.value;
             if (selectedState === 'CONTRATADO' || selectedState === 'NO_APTO') {
                 performanceFields.style.display = 'block';
                 document.getElementById('id_objetivo_ventas_alcanzado').checked = objetivo === 'true';
                 document.getElementById('id_factor_actitud_aplica').checked = actitud === 'true';
             } else {
                 performanceFields.style.display = 'none';
             }
        }
        
        updateSelect.onchange = togglePerformanceFields;
        togglePerformanceFields();
        
        document.getElementById('updateProcessModal').style.display = 'flex';
    }

    function closeUpdateProcessModal() {
        document.getElementById('updateProcessModal').style.display = 'none';
    }
    
    function openHistoryModal(dni, nombre) {
        document.getElementById('history-candidato-dni').textContent = dni;
        document.getElementById('history-candidato-nombre').textContent = nombre;
        const historyContent = document.getElementById('history-content');
        historyContent.innerHTML = '<p class="text-center text-gray-500">Cargando historial...</p>';

        const url = historyApiUrl.replace('DNI_PLACEHOLDER', dni);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                let html = '';
                if (data.procesos && data.procesos.length > 0) {
                    data.procesos.forEach((p, index) => {
                        html += `
                            <div class="border p-3 rounded-lg shadow-sm ${index === 0 ? 'border-red-500 bg-red-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="text-sm font-bold text-gray-800">${index === 0 ? 'ACTIVO (ÚLTIMO)' : 'Proceso Anterior'}</p>
                                <p class="text-xs text-gray-600 mt-1">
                                    <span class="font-semibold">Convocatoria:</span> ${p.fecha_inicio} (${p.empresa_proceso.nombre} - ${p.sede_proceso.nombre})
                                </p>
                                <p class="text-xs text-gray-600">
                                    <span class="font-semibold">Supervisor:</span> ${p.supervisor_nombre || 'Pendiente de Asignar'}
                                </p>
                                <p class="text-xs text-gray-600">
                                    <span class="font-semibold">Resultado Final:</span> <span class="font-bold text-red-600">${p.estado}</span>
                                </p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p class="text-center text-gray-500">No se encontró historial de procesos para este candidato.</p>';
                }
                historyContent.innerHTML = html;
            })
            .catch(error => {
                historyContent.innerHTML = `<p class="text-center text-red-500">Error al cargar el historial: ${error.message}</p>`;
                console.error('Error al cargar historial:', error);
            });

        document.getElementById('historyModal').style.display = 'flex';
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    function openAsistenciaModal(dni, procesoId) {
        const modalElement = document.getElementById('asistenciaModal');
        if (modalElement) {
            document.getElementById('asistencia-proceso-id-input').value = procesoId;
            document.getElementById('asistencia-candidato-dni-display').textContent = dni;
            
            modalElement.style.display = 'flex'; 
        } else {
            console.error("Error: El modal con ID 'asistenciaModal' no fue encontrado en el DOM.");
        }
    }

    function closeAsistenciaModal() {
        document.getElementById('asistenciaModal').style.display = 'none';
    }

    function openConvocarModal(dni, nombre) {
        openInitProcessModal(dni, nombre);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.kanban-column-body').forEach(column => {
            column.addEventListener('dragover', allowDrop);
            column.addEventListener('drop', drop);
            column.id = `column-${column.dataset.status}`;
        });
        
        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', drag);
        });
        
        const messageAlerts = document.querySelectorAll('.message-alert');
        messageAlerts.forEach(alert => {
            setTimeout(() => {
                alert.style.opacity = '0'; 
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 500); 
            }, 5000); 
        });

        const dateButtons = document.querySelectorAll('.filter-date-btn');

        dateButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const selectedDate = event.currentTarget.dataset.date;
                const currentUrl = new URL(window.location.href);
                
                currentUrl.searchParams.set('fecha_inicio', selectedDate);
                
                window.location.href = currentUrl.toString();
            });
        });

        const allDatesButton = document.getElementById('all-dates-filter-btn');
        if (allDatesButton) {
             allDatesButton.addEventListener('click', (event) => {
                 event.preventDefault(); 
                 const currentUrl = new URL(window.location.href);
                 currentUrl.searchParams.delete('fecha_inicio');
                 window.location.href = currentUrl.toString();
             });
        }
        
        const dniSearchInput = document.getElementById('dni-search');
        
        dniSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                
                const searchValue = dniSearchInput.value.trim();
                const currentUrl = new URL(window.location.href);
                
                const isExactDNI = /^\d{8,10}$/.test(searchValue); 

                if (isExactDNI) {
                    fetch(`${API_ASISTENCIA_CHECK_URL}?dni=${searchValue}`)
                        .then(response => response.json())
                        .then(data => {
                            
                            if (data.candidato_encontrado && !data.asistencia_registrada && data.proceso_id) {
                                
                                openAsistenciaModal(data.dni, data.proceso_id);
                                
                                const currentUrl = new URL(window.location.href);
                                currentUrl.searchParams.set('search', searchValue);
                                window.history.pushState({}, '', currentUrl);

                            } else {
                                currentUrl.searchParams.set('search', searchValue);
                                window.location.href = currentUrl.toString();
                            }
                        })
                        .catch(error => {
                            console.error('Error de red o API:', error);
                            currentUrl.searchParams.set('search', searchValue);
                            window.location.href = currentUrl.toString();
                        });
                } else {
                    if (searchValue) {
                        currentUrl.searchParams.set('search', searchValue);
                    } else {
                        currentUrl.searchParams.delete('search');
                    }
                    window.location.href = currentUrl.toString();
                }
            }
        });
         function openMassActionMenu() {
          document.getElementById('massActionMenu').classList.remove('hidden');
         }
        
         function closeMassActionMenu() {
             document.getElementById('massActionMenu').classList.add('hidden');
         }
        
         document.addEventListener('click', function(event) {
             const menu = document.getElementById('massActionMenu');
             const button = document.getElementById('btn-mass-action');
             if (menu && button && !menu.contains(event.target) && !button.contains(event.target) && !menu.classList.contains('hidden')) {
                 closeMassActionMenu();
             }
         });
    });
</script>
{% endblock extra_js %}